<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Sistema ByLiliana - Control de Producci√≥n</title>
    <style>
        /* ========================================================= */
        /* üé® ESTILOS GENERALES Y PALETA DE COLORES */
        /* ========================================================= */
        
        :root {
            --color-primary: #4a148c; /* Morado Profundo (Marca) */
            --color-accent: #ff7043;  /* Naranja V√≠vido (Acci√≥n) */
            --color-success: #388e3c; /* Verde (Terminado) */
            --color-pending: #ffb300; /* √Åmbar (Pendiente) */
            --color-progress: #1976d2; /* Azul (En Progreso) */
            --color-danger: #d32f2f;  /* Rojo (Cancelado/Eliminar) */
            --color-bg-light: #f8f9fa; /* Fondo General */
            --color-card-bg: #ffffff; /* Fondo Tarjetas */
            --color-text: #343a40; /* Texto Principal */
            --border-radius: 8px;
        }

        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            background-color: var(--color-bg-light); 
            color: var(--color-text);
        }
        #root { 
            padding: 20px; 
            max-width: 1500px;
            margin: 0 auto;
        }

        /* ========================================================= */
        /* ‚è´ HEADER Y BOTONES */
        /* ========================================================= */
        
        .header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 30px; 
            padding: 10px 0;
            border-bottom: 3px solid var(--color-primary);
        }
        .header h1 { 
            font-size: 1.8em; 
            color: var(--color-primary); 
            font-weight: 600;
        }
        .header button { 
            padding: 10px 18px; 
            border: none; 
            border-radius: var(--border-radius); 
            cursor: pointer; 
            font-weight: bold;
            transition: background-color 0.2s, transform 0.1s;
            margin-left: 10px;
        }
        .header button:hover {
            transform: translateY(-2px);
        }
        
        /* Estilos espec√≠ficos de botones */
        .header button:not(#manage-users-btn) { background-color: var(--color-primary); color: white; }
        .header button:not(#manage-users-btn):hover { background-color: #5e35b1; }
        #manage-users-btn { background-color: #8E24AA !important; color: white; } /* Morado m√°s brillante para Admin */
        #manage-users-btn:hover { background-color: #791a92 !important; }
        #logout-btn { background-color: var(--color-danger); }
        #logout-btn:hover { background-color: #b71c1c; }


        /* ========================================================= */
        /* üì¶ TARJETAS DE √ìRDENES */
        /* ========================================================= */
        
        .order-list { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); 
            gap: 25px; 
        }
        .order-card { 
            background: var(--color-card-bg); 
            border-radius: var(--border-radius); 
            box-shadow: 0 6px 15px rgba(0,0,0,0.1); 
            overflow: hidden; 
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .order-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.15);
        }
        .card-body { 
            padding: 20px; 
        }
        .card-body strong {
            font-size: 1.2em;
            color: var(--color-accent);
        }
        .card-body hr {
            border: none;
            border-top: 1px solid #e0e0e0;
            margin: 10px 0;
        }
        .card-body p {
            margin: 5px 0;
            font-size: 0.95em;
        }
        .card-footer { 
            display: flex; 
            justify-content: space-between; 
            padding: 15px 20px; 
            background-color: #f1f4f5; 
            border-top: 1px solid #e0e0e0; 
            font-size: 0.85em;
        }
        
        /* Badges de Estado */
        .status-badge { 
            padding: 6px 12px; 
            border-radius: 20px; 
            font-weight: bold; 
            font-size: 0.8em;
            letter-spacing: 0.5px;
        }
        .status-badge.pending { background-color: var(--color-pending); color: white; }
        .status-badge.finished { background-color: var(--color-success); color: white; }
        .status-badge.in-progress { background-color: var(--color-progress); color: white; }
        .status-badge.cancelled { background-color: var(--color-danger); color: white; }
        .image-preview { 
            width: 100%; 
            height: 220px; 
            background-color: #e0e0e0; 
            background-size: cover; /* Cambiado de contain a cover para mejor est√©tica */
            background-repeat: no-repeat; 
            background-position: center; 
            margin-bottom: 15px; 
            border-radius: 5px; 
        }

        /* ========================================================= */
        /* üîí LOGIN SCREEN */
        /* ========================================================= */

        #login-screen {
            background-color: var(--color-primary); 
            /* Se mantiene el layout de centrado */
        }
        #login-form {
            padding: 50px; 
            width: 350px; 
            /* Sombra y esquinas mejoradas */
        }
        #login-form h2 {
            color: var(--color-primary);
            margin-bottom: 25px;
        }
        #login-form input {
            padding: 12px;
            border-radius: 5px;
            font-size: 1em;
        }
        #login-form button {
            background-color: var(--color-accent); 
            padding: 12px;
            font-size: 1.1em;
        }
        #login-form button:hover {
            background-color: #e6603a;
        }
        #login-error { 
            color: var(--color-danger); 
        }

        /* ========================================================= */
        /* üìê MODALES Y FORMULARIOS */
        /* ========================================================= */

        .modal-content { 
            background: var(--color-card-bg); 
            padding: 40px; 
            border-radius: var(--border-radius); 
            max-width: 600px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        .modal-content h3 {
            color: var(--color-primary);
            margin-top: 0;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        .modal-content input, .modal-content textarea, .modal-content select {
            width: 100%;
            padding: 10px;
            margin: 8px 0;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1em;
        }
        .modal-content button[type="submit"], .modal-content button:not(.close-button):not(.close-modal-btn) {
            background-color: var(--color-accent);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        .modal-content button:hover {
            background-color: #e6603a;
        }
        
        #edit-order-form button[type="button"] { 
            background-color: var(--color-danger);
        }
        #edit-order-form button[type="button"]:hover {
            background-color: #b71c1c;
        }
        
        /* Estilos de gesti√≥n de usuarios */
        .user-table { margin-top: 15px; }
        .user-table th, .user-table td { 
            padding: 12px; 
            font-size: 0.9em;
        }
        .user-table select {
            padding: 5px;
            border-radius: 4px;
            background-color: #f9f9f9;
        }
        
    </style>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
</head>
<body>

    <div id="login-screen">
        <div id="login-form">
            <h2>Acceso al Sistema ByLiliana</h2>
            <input type="email" id="login-email" placeholder="Correo Electr√≥nico" required>
            <input type="password" id="login-password" placeholder="Contrase√±a" required>
            <button onclick="handleLogin()">Iniciar Sesi√≥n</button>
            <p id="login-error" style="display: none;">Error de inicio de sesi√≥n.</p>
        </div>
    </div>
    
    <div id="root" style="display: none;">
        <div class="header">
            <h1 id="user-display">Sistema de Producci√≥n (Sesi√≥n: Cargando...)</h1>
            <div>
                <button onclick="openModal('new-order-modal')">‚ûï Nueva Orden</button>
                <button onclick="openModal('settings-modal')">‚öôÔ∏è Ajustes</button>
                <button id="manage-users-btn" onclick="openManageUsersModal()" style="display: none;">üë• Gestionar Usuarios</button>
                <button id="logout-btn" onclick="handleLogout()">üö™ Cerrar Sesi√≥n</button>
            </div>
        </div>
        <div class="order-list" id="order-list">
            </div>
    </div>

    <div id="new-order-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <button class="close-button" onclick="closeModal('new-order-modal')">&times;</button>
            <h3>Crear Nueva Orden</h3>
            <form id="new-order-form">
                <input type="number" id="new-order-id" placeholder="ID/C√≥digo de Orden" required><br>
                <input type="text" id="new-order-client" placeholder="Cliente" required><br>
                <input type="text" id="new-order-model" placeholder="Modelo/C√≥digo de Dise√±o" required oninput="updateImagePreview(this.value, 'new-image-preview')"><br>
                <div id="new-image-preview" class="image-preview"></div>
                <textarea id="new-order-details" placeholder="Detalles de la Orden" rows="4"></textarea><br>
                <select id="new-order-status" required>
                    <option value="pending">Pendiente</option>
                    <option value="in-progress">En Progreso</option>
                </select><br><br>
                <button type="submit">Guardar Orden</button>
            </form>
        </div>
    </div>

    <div id="settings-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <button class="close-button" onclick="closeModal('settings-modal')">&times;</button>
            <h3>Configuraci√≥n de Repositorios de Im√°genes</h3>
            <div id="current-repos">
                <h4>Repositorios Activos:</h4>
                <ul id="repo-list" style="list-style-type: none; padding: 0;"></ul>
            </div>
            <hr>
            <h4>A√±adir Nuevo Repositorio:</h4>
            <input type="text" id="new-repo-url" placeholder="Ej: file://///NombreDeTuPC/Carpeta/" style="width: 100%; padding: 8px;"><br><br>
            <button onclick="addRepoUrl()">A√±adir</button>
            <button onclick="saveSettings()" style="margin-left: 10px;">Guardar Configuraci√≥n</button>
        </div>
    </div>
    
    <div id="edit-order-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <button class="close-button" onclick="closeModal('edit-order-modal')">&times;</button>
            <h3>Editar Orden</h3>
            <form id="edit-order-form">
                <input type="hidden" id="edit-order-id-hidden">
                <input type="number" id="edit-order-id" placeholder="ID/C√≥digo de Orden" readonly><br>
                <input type="text" id="edit-order-client" placeholder="Cliente" required><br>
                <input type="text" id="edit-order-model" placeholder="Modelo/C√≥digo de Dise√±o" required oninput="updateImagePreview(this.value, 'edit-image-preview')"><br>
                <div id="edit-image-preview" class="image-preview"></div>
                <textarea id="edit-order-details" placeholder="Detalles de la Orden" rows="4"></textarea><br>
                <select id="edit-order-status" required>
                    <option value="pending">Pendiente</option>
                    <option value="in-progress">En Progreso</option>
                    <option option value="finished">Terminado</option>
                    <option value="cancelled">Cancelada</option>
                </select><br><br>
                <button type="submit">Actualizar Orden</button>
                <button type="button" onclick="deleteOrder()" id="delete-order-btn" style="margin-left: 10px;">Eliminar Orden</button>
            </form>
        </div>
    </div>
    
    <div id="manage-users-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 700px;">
            <button class="close-button" onclick="closeModal('manage-users-modal')">&times;</button>
            <h3>Gesti√≥n de Roles de Usuarios</h3>
            <p style="font-size: 0.9em; color: #6c757d;">Aqu√≠ puedes asignar el nivel de acceso a cada usuario. (Admin, Editor o Visor).</p>
            <div style="max-height: 400px; overflow-y: auto;">
                <table id="user-role-table" class="user-table" style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr>
                            <th>Email</th>
                            <th>UID</th>
                            <th>Rol Actual</th>
                            <th>Asignar Nuevo Rol</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
            <button onclick="closeModal('manage-users-modal')" style="margin-top: 20px; background-color: #6c757d;">Cerrar</button>
        </div>
    </div>

    <script>
        // Configuraci√≥n de Firebase
        const firebaseConfig = {
            // REEMPLAZA ESTAS CLAVES CON LAS TUYAS
            apiKey: "AIzaSyBqHgV4vDat1-VmZfKbiPg7nuiX-ROcexw", 
            authDomain: "cirineo-cec21.firebaseapp.com",
            projectId: "cirineo-cec21",
            storageBucket: "cirineo-cec21.firebasestorage.app",
            messagingSenderId: "620210618284",
            appId: "1:620210618284:web:482bab9bf74650fff18409",
            measurementId: "G-B7YLM78RVW"
        };
        
        // El email que siempre ser√° el Admin
        const ADMIN_EMAIL = 'jesus.dev@byliliana.com';

        let db;
        let currentUserRole = 'viewer';
        let repoUrls = [];
        let usersCollection;
        
        // ----------------------------------------------------------------------
        // L√ìGICA DE AUTENTICACI√ìN Y ROLES
        // ----------------------------------------------------------------------
        
        function handleLogin() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorElement = document.getElementById('login-error');
            errorElement.style.display = 'none';
            
            firebase.auth().signInWithEmailAndPassword(email, password)
                .catch((error) => {
                    errorElement.textContent = `Error: ${error.code.split('/')[1].replace(/-/g, ' ')}`;
                    errorElement.style.display = 'block';
                });
        }
        
        function handleLogout() {
            firebase.auth().signOut().then(() => {
                window.location.reload(); 
            });
        }
        
        // Inicializaci√≥n y Monitoreo de Sesi√≥n
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore(); 
        usersCollection = db.collection('users');

        firebase.auth().onAuthStateChanged((user) => {
            if (user) {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('root').style.display = 'block';
                
                checkUserRole(user);

            } else {
                document.getElementById('root').style.display = 'none';
                document.getElementById('login-screen').style.display = 'flex';
            }
        });
        
        async function checkUserRole(user) {
            document.getElementById('user-display').textContent = `Sistema de Producci√≥n (Sesi√≥n: ${user.email})`;
            const userDocRef = usersCollection.doc(user.uid);
            const userDoc = await userDocRef.get();
            
            if (userDoc.exists) {
                currentUserRole = userDoc.data().role || 'viewer';
            } else {
                currentUserRole = user.email === ADMIN_EMAIL ? 'admin' : 'editor';
                
                await userDocRef.set({ 
                    email: user.email, 
                    role: currentUserRole 
                });
            }
            
            startApp(currentUserRole);
        }

        // ----------------------------------------------------------------------
        // L√ìGICA DE PERMISOS Y APLICACI√ìN PRINCIPAL
        // ----------------------------------------------------------------------

        function startApp(role) {
            
            // Controla visibilidad de Gesti√≥n de Usuarios
            document.getElementById('manage-users-btn').style.display = (role === 'admin' ? 'inline-block' : 'none');
            
            // Ocultar botones de acci√≥n si es Visor
            if (role === 'viewer') {
                document.querySelector('.header button[onclick="openModal(\'new-order-modal\')"]').style.display = 'none';
                // El bot√≥n de Ajustes se deja para que pueda ver los repos, aunque no pueda guardar
            } else {
                 document.querySelector('.header button[onclick="openModal(\'new-order-modal\')"]').style.display = 'inline-block';
            }


            // ----------------------------------------------------
            // L√≥gica de Repositorios (Settings)
            // ----------------------------------------------------
            
            const settingsDoc = db.collection('settings').doc('image_repos');

            settingsDoc.onSnapshot(doc => {
                if (doc.exists) {
                    repoUrls = doc.data().urls || [];
                    renderRepoList();
                } else {
                    repoUrls = [];
                    renderRepoList();
                    settingsDoc.set({ urls: repoUrls });
                }
            });

            function renderRepoList() {
                const list = document.getElementById('repo-list');
                list.innerHTML = '';
                if (repoUrls.length === 0) {
                    list.innerHTML = '<li style="color:#6c757d;">No hay repositorios configurados.</li>';
                    return;
                }
                repoUrls.forEach((url, index) => {
                    const li = document.createElement('li');
                    li.textContent = url;
                    li.style.borderBottom = '1px dotted #ccc';
                    li.style.padding = '8px 0';
                    li.style.wordBreak = 'break-all'; // Para URLs largas
                    
                    if (role === 'admin') {
                         const deleteBtn = document.createElement('button');
                         deleteBtn.textContent = 'Eliminar';
                         deleteBtn.style.marginLeft = '10px';
                         deleteBtn.style.backgroundColor = 'var(--color-danger)';
                         deleteBtn.style.padding = '5px 10px';
                         deleteBtn.style.fontSize = '0.8em';
                         deleteBtn.onclick = () => removeRepoUrl(index);
                         li.appendChild(deleteBtn);
                    }
                    list.appendChild(li);
                });
            }

            function addRepoUrl() {
                if (role !== 'admin') return alert('Permiso denegado. Solo administradores pueden a√±adir repositorios.');
                const input = document.getElementById('new-repo-url');
                const url = input.value.trim();
                if (url && !repoUrls.includes(url)) {
                    // Asegurar que la URL termine con /
                    const finalUrl = url.endsWith('/') ? url : url + '/';
                    repoUrls.push(finalUrl);
                    input.value = '';
                    renderRepoList();
                }
            }

            function removeRepoUrl(index) {
                if (role !== 'admin') return alert('Permiso denegado.');
                repoUrls.splice(index, 1);
                renderRepoList();
            }

            function saveSettings() {
                if (role !== 'admin') return alert('Permiso denegado. Solo administradores pueden guardar la configuraci√≥n.');
                settingsDoc.set({ urls: repoUrls })
                    .then(() => {
                        alert("Configuraci√≥n de repositorios guardada.");
                        closeModal('settings-modal');
                    })
                    .catch(error => {
                        console.error("Error al guardar la configuraci√≥n: ", error);
                        alert("Error al guardar la configuraci√≥n.");
                    });
            }

            // ----------------------------------------------------
            // L√≥gica de √ìrdenes 
            // ----------------------------------------------------
            
            const ordersCollection = db.collection('orders');
            const orderListElement = document.getElementById('order-list');
            
            function renderOrderCard(order) {
                 const card = document.createElement('div');
                 card.className = 'order-card';
                 
                 // Permite abrir modal de edici√≥n a Editores o Administradores
                 if (role === 'admin' || role === 'editor') {
                    card.onclick = () => openEditModal(order); 
                 }
                 
                 let statusClass = order.status;
                 let dateDisplay = new Date(order.timestamp).toLocaleDateString();

                 // Si el timestamp es muy reciente (ej. hoy), mostrar la hora
                 const today = new Date();
                 const orderDate = new Date(order.timestamp);
                 if (orderDate.toDateString() === today.toDateString()) {
                     dateDisplay = 'Hoy, ' + orderDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                 }
                 
                 card.innerHTML = `
                     <div class="card-body">
                         <strong>#${order.id}</strong> - ${order.client}
                         <hr>
                         <p>Modelo: <strong>${order.model}</strong></p>
                         <p>Detalles: ${order.details.length > 50 ? order.details.substring(0, 50) + '...' : order.details}</p>
                         <div class="image-preview" id="preview-${order.id}"></div>
                     </div>
                     <div class="card-footer">
                         <span class="status-badge ${statusClass}">${statusClass.toUpperCase().replace('-', ' ')}</span>
                         <span>√öltima act.: ${dateDisplay}</span>
                     </div>
                 `;

                 orderListElement.appendChild(card);
                 smartLoadImage(order.model, `preview-${order.id}`);
             }

            // Funci√≥n principal para cargar y escuchar cambios
            ordersCollection.onSnapshot((snapshot) => {
                orderListElement.innerHTML = '';
                const orders = [];
                snapshot.forEach(doc => {
                    orders.push({ id: doc.id, ...doc.data() });
                });
                
                orders.sort((a, b) => parseInt(a.id) - parseInt(b.id));

                orders.forEach(renderOrderCard);
            });

            // Smart Image Loader (Se mantiene igual)
            function smartLoadImage(modelCode, elementId) {
                const element = document.getElementById(elementId);
                const imageFile = modelCode.toUpperCase().replace(/\s/g, '') + '.jpg';
                
                element.style.backgroundImage = 'none'; // Limpiar previo
                element.style.backgroundColor = '#e0e0e0';
                
                let imageLoaded = false;

                // Usar una promesa para manejar la carga secuencial de URLs
                const loadPromises = repoUrls.map(baseUrl => {
                    return new Promise((resolve) => {
                        if (imageLoaded) return resolve(true);

                        const fullUrl = baseUrl + imageFile;
                        const img = new Image();
                        
                        img.onload = () => {
                            if (!imageLoaded) { // Si ya se carg√≥ una, ignorar las dem√°s
                                element.style.backgroundImage = `url('${fullUrl}')`;
                                element.style.backgroundColor = 'transparent';
                                imageLoaded = true;
                            }
                            resolve(true); // Resuelve la promesa
                        };
                        img.onerror = () => {
                            resolve(false); // Falla, intenta el siguiente
                        };
                        img.src = fullUrl;
                    });
                });
                
                // Ejecutar todas las promesas (intentos de carga)
                Promise.all(loadPromises).then(() => {
                    if (!imageLoaded) {
                        element.style.backgroundColor = '#f0f0f0'; // Si fallan todas
                    }
                });
            }

            function updateImagePreview(modelCode, elementId) {
                smartLoadImage(modelCode, elementId);
            }

            // L√≥gica para guardar/crear nueva orden (Solo Editores y Admin)
            document.getElementById('new-order-form').onsubmit = function(e) {
                e.preventDefault();
                if (role !== 'admin' && role !== 'editor') return alert('Permiso denegado. Solo Editores pueden crear √≥rdenes.');
                
                const id = document.getElementById('new-order-id').value;
                const orderPayload = {
                    id: String(id),
                    client: document.getElementById('new-order-client').value,
                    model: document.getElementById('new-order-model').value,
                    details: document.getElementById('new-order-details').value,
                    status: document.getElementById('new-order-status').value,
                    timestamp: Date.now()
                };

                ordersCollection.doc(orderPayload.id).set(orderPayload)
                    .then(() => {
                        closeModal('new-order-modal');
                        document.getElementById('new-order-form').reset();
                        alert('Orden creada con √©xito!');
                    })
                    .catch(error => {
                        console.error("Error al crear la orden: ", error);
                        alert('Error al crear la orden. Verifica que el ID no exista.');
                    });
            };

            // L√≥gica para editar/actualizar orden (Solo Editores y Admin)
            let currentEditOrderId = null;

            function openEditModal(order) {
                if (role !== 'admin' && role !== 'editor') return alert('Permiso denegado. Solo Editores pueden modificar.');

                currentEditOrderId = order.id;
                document.getElementById('edit-order-id-hidden').value = order.id;
                document.getElementById('edit-order-id').value = order.id;
                document.getElementById('edit-order-client').value = order.client;
                document.getElementById('edit-order-model').value = order.model;
                document.getElementById('edit-order-details').value = order.details;
                document.getElementById('edit-order-status').value = order.status;
                
                document.getElementById('delete-order-btn').style.display = (role === 'admin' ? 'inline-block' : 'none');
                
                updateImagePreview(order.model, 'edit-image-preview');

                openModal('edit-order-modal');
            }

            document.getElementById('edit-order-form').onsubmit = function(e) {
                e.preventDefault();
                if (role !== 'admin' && role !== 'editor') return alert('Permiso denegado.');
                
                if (!currentEditOrderId) return;

                const updatedPayload = {
                    id: String(currentEditOrderId),
                    client: document.getElementById('edit-order-client').value,
                    model: document.getElementById('edit-order-model').value,
                    details: document.getElementById('edit-order-details').value,
                    status: document.getElementById('edit-order-status').value,
                    timestamp: Date.now()
                };

                ordersCollection.doc(currentEditOrderId).update(updatedPayload)
                    .then(() => {
                        closeModal('edit-order-modal');
                        currentEditOrderId = null;
                        alert('Orden actualizada con √©xito!');
                    })
                    .catch(error => {
                        console.error("Error al actualizar la orden: ", error);
                        alert('Error al actualizar la orden.');
                    });
            };

            // L√≥gica para eliminar orden (Solo Admin)
            function deleteOrder() {
                if (role !== 'admin') return alert('Permiso denegado. Solo Administradores pueden eliminar √≥rdenes.');
                
                if (!currentEditOrderId || !confirm(`¬øEst√°s seguro de ELIMINAR la orden #${currentEditOrderId}? Esta acci√≥n es irreversible.`)) {
                    return;
                }

                ordersCollection.doc(currentEditOrderId).delete()
                    .then(() => {
                        closeModal('edit-order-modal');
                        currentEditOrderId = null;
                        alert('Orden eliminada con √©xito!');
                    })
                    .catch(error => {
                        console.error("Error al eliminar la orden: ", error);
                        alert('Error al eliminar la orden.');
                    });
            }

            // ----------------------------------------------------
            // L√≥gica de Gesti√≥n de Usuarios (SOLO ADMIN)
            // ----------------------------------------------------
            
            function openManageUsersModal() {
                if (role !== 'admin') return alert('Permiso denegado. Solo Administradores pueden gestionar usuarios.');
                renderUserTable();
                openModal('manage-users-modal');
            }
            
            function renderUserTable() {
                const tableBody = document.getElementById('user-role-table').querySelector('tbody');
                tableBody.innerHTML = '<tr><td colspan="4">Cargando usuarios...</td></tr>';
                
                usersCollection.get().then(snapshot => {
                    tableBody.innerHTML = '';
                    snapshot.forEach(doc => {
                        const user = doc.data();
                        const uid = doc.id;
                        const row = document.createElement('tr');
                        
                        // Si el usuario es el propio Jes√∫s Vallejo (el ADMIN_EMAIL), no permitir cambiar su rol
                        const isSelfAdmin = user.email === ADMIN_EMAIL;
                        
                        const selectHtml = isSelfAdmin ? user.role.toUpperCase() + ' (Fijo)' : `
                            <select onchange="updateUserRole('${uid}', this.value)">
                                <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
                                <option value="editor" ${user.role === 'editor' ? 'selected' : ''}>Editor</option>
                                <option value="viewer" ${user.role === 'viewer' ? 'selected' : ''}>Visor</option>
                            </select>
                        `;

                        row.innerHTML = `
                            <td>${user.email}</td>
                            <td>${uid.substring(0, 6)}...</td>
                            <td><span class="status-badge" style="background-color: ${user.role === 'admin' ? '#4a148c' : (user.role === 'editor' ? '#1976d2' : '#6c757d')}; color: white;">${user.role.toUpperCase()}</span></td>
                            <td>${selectHtml}</td>
                        `;
                        tableBody.appendChild(row);
                    });
                });
            }
            
            function updateUserRole(uid, newRole) {
                if (role !== 'admin') return alert('Permiso denegado.');
                
                usersCollection.doc(uid).update({ role: newRole })
                    .then(() => {
                        alert(`Rol del usuario actualizado a ${newRole}. Recargue la app para aplicar cambios.`);
                        renderUserTable();
                    })
                    .catch(error => {
                        console.error("Error al actualizar rol: ", error);
                        alert("Error al actualizar el rol.");
                    });
            }
            
            // ----------------------------------------------------
            // L√≥gica de Modales
            // ----------------------------------------------------
            
            function openModal(id) {
                document.getElementById(id).style.display = 'flex';
            }

            function closeModal(id) {
                document.getElementById(id).style.display = 'none';
            }
            
            // Funciones globales (para onclick en HTML)
            window.openModal = openModal;
            window.closeModal = closeModal;
            window.deleteOrder = deleteOrder;
            window.updateImagePreview = updateImagePreview;
            window.addRepoUrl = addRepoUrl;
            window.saveSettings = saveSettings;
            window.openManageUsersModal = openManageUsersModal;
            window.updateUserRole = updateUserRole;
        }

        // Funciones globales (para login/logout)
        window.handleLogin = handleLogin;
        window.handleLogout = handleLogout;
        
    </script>
</body>
</html>
