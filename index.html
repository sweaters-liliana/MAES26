<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Textil Cloud - Cirineo v3.1</title>
    
    <link id="appIcon" rel="icon" href="https://raw.githubusercontent.com/jesusvn1993mplvt3-ai/CIRINEO/refs/heads/main/icon.ico">
    <link id="appAppleIcon" rel="apple-touch-icon" href="https://raw.githubusercontent.com/jesusvn1993mplvt3-ai/CIRINEO/refs/heads/main/icon.ico">
    <meta name="theme-color" content="#1e293b">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        body { background-color: #f1f5f9; color: #1e293b; font-family: system-ui, -apple-system, sans-serif; }
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; padding: 16px; }
        .card-enter { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Estilos del modal (para archivo) */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.5); z-index: 1000;
            display: flex; justify-content: center; align-items: center;
        }
        .modal-content {
            background: #fff; padding: 30px; border-radius: 8px;
            width: 90%; max-width: 600px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            animation: modalFadeIn 0.3s ease-out;
        }
        @keyframes modalFadeIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }

        /* Scrollbars (Igual que el archivo 3) */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #e2e8f0; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;

        // --- CONFIGURACIÓN FIREBASE (Misma que todos) ---
        const firebaseConfig = {
            apiKey: "AIzaSyBqHgV4vDat1-VmZfKbiPg7nuiX-ROcexw",
            authDomain: "cirineo-cec21.firebaseapp.com",
            projectId: "cirineo-cec21",
            storageBucket: "cirineo-cec21.firebasestorage.app",
            messagingSenderId: "620210618284",
            appId: "1:620210618284:web:482bab9bf74650fff18409",
            measurementId: "G-B7YLM78RVW"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- COMPONENTE ICONO ---
        const Icon = ({ name, size = 18, className }) => {
            const containerRef = React.useRef(null);
            React.useEffect(() => {
                if (containerRef.current && lucide.icons[name]) {
                    containerRef.current.innerHTML = lucide.icons[name].toSvg({ width: size, height: size, class: className });
                }
            }, [name, size, className]);
            return <span ref={containerRef} className="inline-flex items-center justify-center"></span>;
        };

        // --- UTILIDADES ---
        const formatDate = (dateString) => {
            if (!dateString) return '---';
            const date = new Date(dateString);
            return date.toLocaleDateString('es-ES', { day: '2-digit', month: 'short', year: 'numeric' });
        };
        const calculateProgress = (progreso) => {
            if (!progreso || progreso.length === 0) return 0;
            const finishedCount = progreso.filter(p => p.finished).length;
            return Math.round((finishedCount / progreso.length) * 100);
        };
        const isCompleted = (progreso) => {
            if (!progreso || progreso.length === 0) return false;
            return progreso.every(p => p.finished);
        };


        // --- NUEVO: BOTÓN Y MODAL DE ARCHIVO ---
        const ArchiveButton = ({ order, onArchive }) => {
            const [showModal, setShowModal] = useState(false);
            const [historyData, setHistoryData] = useState(null);
            const [loading, setLoading] = useState(false);

            const handleOpenModal = async () => {
                setLoading(true);
                setShowModal(true);
                
                try {
                    // 1. Obtener los IDs de escaneo de los paquetes finalizados
                    const scanIds = order.progreso
                        .filter(p => p.finished && p.scanRef)
                        .map(p => p.scanRef);

                    if (scanIds.length === 0) {
                        setHistoryData([]);
                        setLoading(false);
                        return;
                    }

                    // 2. Consultar la colección registro_produccion usando los IDs
                    const scansPromises = scanIds.map(id => db.collection('registro_produccion').doc(id).get());
                    const scansSnapshots = await Promise.all(scansPromises);
                    
                    const history = scansSnapshots.map(snap => {
                        if (!snap.exists) return null;
                        const data = snap.data();
                        
                        // Formato de fechas para mostrar
                        const scanDate = data.fecha_scan || 'Fecha desconocida';
                        const printDate = data.fechaImpresion ? data.fechaImpresion.split(' ')[0] : 'Fecha desconocida';
                        const printTime = data.fechaImpresion ? data.fechaImpresion.split(' ')[1] : 'Hora desconocida';
                        
                        return {
                            paquete: data.paquete_indice,
                            tejedor: data.tejedor,
                            fechaImpresion: formatDate(printDate),
                            horaImpresion: printTime,
                            fechaEscaneo: scanDate,
                            status: data.status,
                            id: snap.id
                        };
                    }).filter(item => item !== null);

                    setHistoryData(history.sort((a, b) => a.paquete - b.paquete));
                } catch (error) {
                    console.error("Error al obtener historial de escaneo:", error);
                    alert("Error al cargar el historial de escaneo.");
                } finally {
                    setLoading(false);
                }
            };
            
            const handleArchive = () => {
                if (historyData) {
                    onArchive(order.id, historyData);
                    setShowModal(false);
                } else {
                    alert("Cargando datos. Intente de nuevo.");
                }
            };

            const isReadyToArchive = isCompleted(order.progreso);

            if (!isReadyToArchive) return null;

            return (
                <>
                    <button 
                        onClick={handleOpenModal}
                        className="w-full bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold py-2 rounded-lg mt-3 flex items-center justify-center gap-2 transition transform hover:scale-[1.01] shadow-md shadow-blue-500/30"
                    >
                        <Icon name="archive" size={16} /> ARCHIVAR ORDEN (COMPLETA)
                    </button>
                    
                    {showModal && (
                        <div className="modal-overlay">
                            <div className="modal-content">
                                <h2 className="text-xl font-black text-slate-800 border-b pb-2 mb-4 flex items-center gap-2">
                                    <Icon name="file-archive" size={24}/> Confirmar Archivo: {order.modelo}
                                </h2>
                                
                                {loading ? (
                                    <div className="text-center py-10 text-slate-500">
                                        <div className="w-6 h-6 border-2 border-slate-500 border-t-transparent rounded-full animate-spin mx-auto mb-3"></div>
                                        Cargando historial de escaneo...
                                    </div>
                                ) : (
                                    <>
                                        <p className="text-sm text-slate-600 mb-4">La orden está **100% completada**. Al archivar, se guardarán las siguientes métricas de impresión y escaneo para su historial.</p>
                                        
                                        <div className="max-h-60 overflow-y-auto border border-slate-200 rounded p-2">
                                            <table className="w-full text-sm">
                                                <thead className="sticky top-0 bg-slate-50 border-b">
                                                    <tr>
                                                        <th className="p-2 text-left text-xs font-semibold text-slate-600">PQT</th>
                                                        <th className="p-2 text-left text-xs font-semibold text-slate-600">Impresión</th>
                                                        <th className="p-2 text-left text-xs font-semibold text-slate-600">Escaneo</th>
                                                        <th className="p-2 text-left text-xs font-semibold text-slate-600">Tejedor</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {historyData && historyData.map((h, i) => (
                                                        <tr key={i} className="border-b last:border-b-0 hover:bg-slate-50">
                                                            <td className="p-2 font-mono text-slate-800">{h.paquete}</td>
                                                            <td className="p-2 text-xs">{h.fechaImpresion} ({h.horaImpresion})</td>
                                                            <td className="p-2 text-xs text-green-700 font-bold">{h.fechaEscaneo}</td>
                                                            <td className="p-2 text-xs">{h.tejedor || 'S/N'}</td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>

                                        <div className="flex justify-end gap-3 mt-6">
                                            <button onClick={() => setShowModal(false)} className="bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-2 px-4 rounded-lg text-sm">
                                                Cancelar
                                            </button>
                                            <button onClick={handleArchive} className="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg text-sm flex items-center gap-2">
                                                <Icon name="check-circle" size={18}/> ARCHIVAR Y FINALIZAR
                                            </button>
                                        </div>
                                    </>
                                )}
                            </div>
                        </div>
                    )}
                </>
            );
        };

        // --- TARJETA DE ORDEN (COMPONENT) ---
        const OrderCard = ({ order, onSelect }) => {
            const pct = useMemo(() => calculateProgress(order.progreso), [order.progreso]);
            const isFinished = useMemo(() => isCompleted(order.progreso), [order.progreso]);
            
            return (
                <div 
                    onClick={() => onSelect(order)}
                    className={`bg-white rounded-lg p-4 shadow-lg border-l-4 cursor-pointer transition transform hover:scale-[1.01] card-enter 
                        ${order.status === 'ARCHIVADO' ? 'border-slate-500' : 'border-indigo-600'}
                    `}
                >
                    <div className="flex justify-between items-start mb-2">
                        <span className="text-xs font-bold text-slate-500 bg-slate-100 px-2 py-1 rounded">
                            ID: {order.id}
                        </span>
                        <div className={`text-xs font-bold px-2 py-1 rounded-full ${isFinished ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}`}>
                            {isFinished ? 'COMPLETA' : 'EN CURSO'}
                        </div>
                    </div>
                    <h3 className="text-lg font-black text-slate-800 leading-tight">{order.modelo}</h3>
                    <p className="text-sm font-medium text-indigo-600 mb-3">{order.partida}</p>

                    <div className="text-[10px] text-slate-500 mb-1">
                        <span className="font-bold">Máquina:</span> {order.maquina || 'N/A'} | 
                        <span className="font-bold ml-2">Cliente:</span> {order.cliente || 'N/A'}
                    </div>
                    <div className="text-[10px] text-slate-400">Total: {order.totalPedido} pzs</div>
                    
                    <div className="mt-3 w-full bg-slate-200 h-2 rounded overflow-hidden">
                        <div className={`h-full transition-all duration-500 ${order.status === 'ARCHIVADO' ? 'bg-slate-500' : (pct === 100 ? 'bg-green-600' : 'bg-indigo-500')}`} style={{width:`${pct}%`}}></div>
                    </div>
                    <div className="text-right text-[10px] font-bold text-slate-600 mt-1">{pct}%</div>
                    
                    {order.status === 'ARCHIVADO' && 
                        <div className="text-center text-[10px] font-black text-slate-500 mt-2 p-1 border border-slate-300 rounded-full">
                            ARCHIVADO
                        </div>
                    }
                </div>
            );
        };


        // --- DASHBOARD INFERIOR (COMPONENTE PRINCIPAL) ---
        const DashboardBottom = ({ activeOrders, onArchiveOrder }) => {
            const [selectedOrder, setSelectedOrder] = useState(null);
            
            // Sincroniza la selección si la orden activa se archiva
            useEffect(() => {
                if (selectedOrder && selectedOrder.status === 'ARCHIVADO') {
                    setSelectedOrder(null);
                }
            }, [activeOrders]); 

            // Función para actualizar el paquete seleccionado
            const handleUpdatePackage = async (orderId, paqueteNum, field, value) => {
                if (!orderId || !selectedOrder) return;
                
                try {
                    const orderDocRef = db.collection('orders').doc(orderId);
                    const updatedProgreso = selectedOrder.progreso.map(p => {
                        if (p.paqueteNum === paqueteNum) {
                            return { ...p, [field]: value };
                        }
                        return p;
                    });
                    
                    await orderDocRef.update({ progreso: updatedProgreso, lastUpdated: firebase.firestore.FieldValue.serverTimestamp() });
                    // Actualizar el estado local para reflejar el cambio inmediatamente
                    setSelectedOrder(prev => ({ ...prev, progreso: updatedProgreso }));

                } catch (error) {
                    alert("Error al actualizar: " + error.message);
                }
            };


            return (
                <div className="flex-1 flex overflow-hidden bg-white rounded-t-xl shadow-inner border-t border-slate-200">
                    
                    {/* COLUMNA 1: PROGRESO */}
                    <div className="w-1/3 p-4 border-r border-slate-200 overflow-y-auto bg-slate-50">
                        <h2 className="text-lg font-black text-slate-800 mb-4 border-b pb-2 flex items-center gap-2">
                            <Icon name="layout-list" size={20}/> PROGRESO GENERAL
                        </h2>
                        
                        {selectedOrder ? (
                            <>
                                <h3 className="font-bold text-base text-indigo-700">{selectedOrder.modelo}</h3>
                                <p className="text-xs text-slate-500 mb-3">{selectedOrder.partida}</p>
                                
                                <div className="space-y-2">
                                    {selectedOrder.progreso.map(p => {
                                        const isFinished = p.finished;
                                        return (
                                            <div 
                                                key={p.paqueteNum} 
                                                className={`p-3 rounded-lg flex justify-between items-center transition duration-200 ${isFinished ? 'bg-green-50/70 border border-green-200' : 'bg-white border border-slate-200'}`}
                                            >
                                                <div className="flex items-center gap-3">
                                                    <div className={`font-black w-6 h-6 rounded flex items-center justify-center text-xs ${isFinished ? 'bg-green-600 text-white' : 'bg-slate-300 text-slate-700'}`}>
                                                        {p.paqueteNum}
                                                    </div>
                                                    <div>
                                                        <p className="text-sm font-semibold text-slate-700">Paquete {p.paqueteNum}</p>
                                                        <p className="text-xs text-slate-500 leading-none">Pzs: {p.cantidad}</p>
                                                    </div>
                                                </div>
                                                <div className="text-right">
                                                    {isFinished ? (
                                                        <div className="text-green-600 font-bold text-xs flex items-center gap-1">
                                                            <Icon name="check-circle" size={14}/> TERMINADO
                                                        </div>
                                                    ) : (
                                                        <div className="text-yellow-600 font-bold text-xs flex items-center gap-1">
                                                            <Icon name="hourglass" size={14}/> PENDIENTE
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                                <button onClick={() => setSelectedOrder(null)} className="mt-4 text-xs text-indigo-600 hover:text-indigo-800 font-medium flex items-center gap-1">
                                    <Icon name="arrow-left" size={14}/> Volver a la lista
                                </button>
                            </>
                        ) : (
                            <div className="text-center py-10 text-slate-400">
                                <Icon name="mouse-pointer-2" size={32} className="mx-auto mb-2"/>
                                <p className="text-sm">Selecciona una orden para ver su progreso detallado.</p>
                            </div>
                        )}
                    </div>

                    {/* COLUMNA 2: LLENADO DIGITAL */}
                    <div className="w-2/3 p-4 overflow-y-auto">
                        <h2 className="text-lg font-black text-slate-800 mb-4 border-b pb-2 flex items-center gap-2">
                            <Icon name="pen-tool" size={20}/> LLENADO DIGITAL
                        </h2>
                        
                        {selectedOrder ? (
                            <>
                                <div className="mb-4 bg-indigo-50 border border-indigo-200 p-3 rounded-lg text-sm text-indigo-700 font-medium">
                                    <span className="font-bold">{selectedOrder.modelo}</span> | {selectedOrder.partida} - {selectedOrder.totalPedido} Pzs.
                                </div>

                                {/* Botón de Archivo (Si la orden está completa) */}
                                <ArchiveButton order={selectedOrder} onArchive={onArchiveOrder} />

                                <div className="space-y-4 mt-4">
                                    {selectedOrder.progreso.map(p => {
                                        const isFinished = p.finished;
                                        return (
                                            <div 
                                                key={p.paqueteNum} 
                                                className={`p-4 rounded-lg shadow-md transition duration-200 ${isFinished ? 'bg-green-50 border border-green-300' : 'bg-white border border-slate-300'}`}
                                            >
                                                <div className="flex justify-between items-start mb-3">
                                                    <div className="flex items-center gap-2">
                                                        <div className={`font-black w-8 h-8 rounded-full flex items-center justify-center text-sm ${isFinished ? 'bg-green-600 text-white' : 'bg-slate-300 text-slate-700'}`}>
                                                            {p.paqueteNum}
                                                        </div>
                                                        <span className="font-bold text-base text-slate-800">Paquete {p.paqueteNum} ({p.cantidad} pzs)</span>
                                                    </div>
                                                    {isFinished && (
                                                        <div className="text-green-600 font-bold text-sm flex items-center gap-1">
                                                            <Icon name="check-check" size={16}/> Sincronizado
                                                        </div>
                                                    )}
                                                </div>
                                                
                                                <div className="grid grid-cols-2 gap-4">
                                                    <div className="flex flex-col">
                                                        <label className="text-xs font-semibold text-slate-500 mb-1">Tejedor (Sincronizado)</label>
                                                        <input 
                                                            type="text"
                                                            value={p.tejedor || ''}
                                                            onChange={(e) => handleUpdatePackage(selectedOrder.id, p.paqueteNum, 'tejedor', e.target.value)}
                                                            className={`p-2 border rounded text-sm ${isFinished ? 'bg-green-100/50 border-green-300' : 'bg-white border-slate-300'}`}
                                                            disabled={isFinished}
                                                        />
                                                        {isFinished && <p className="text-[10px] text-green-700 mt-1">Sincronizado por escáner el {p.fecha}</p>}
                                                    </div>
                                                    <div className="flex flex-col">
                                                        <label className="text-xs font-semibold text-slate-500 mb-1">Defectos</label>
                                                        <input 
                                                            type="number"
                                                            value={p.defectos || ''}
                                                            onChange={(e) => handleUpdatePackage(selectedOrder.id, p.paqueteNum, 'defectos', e.target.value)}
                                                            className="p-2 border border-slate-300 rounded text-sm"
                                                            disabled={selectedOrder.status === 'ARCHIVADO'}
                                                        />
                                                    </div>
                                                    <div className="flex flex-col col-span-2">
                                                        <label className="text-xs font-semibold text-slate-500 mb-1">Agujas</label>
                                                        <textarea 
                                                            value={p.agujas || ''}
                                                            onChange={(e) => handleUpdatePackage(selectedOrder.id, p.paqueteNum, 'agujas', e.target.value)}
                                                            className="p-2 border border-slate-300 rounded text-sm h-12 resize-none"
                                                            disabled={selectedOrder.status === 'ARCHIVADO'}
                                                        />
                                                    </div>
                                                </div>

                                            </div>
                                        );
                                    })}
                                </div>
                            </>
                        ) : (
                            <div className="text-center py-20 text-slate-400">
                                <Icon name="layout-sidebar-left-collapse" size={48} className="mx-auto mb-4"/>
                                <p className="text-lg font-bold">Selecciona una tarjeta para ver el Llenado Digital.</p>
                                <p className="text-sm">Aquí verás los datos del escáner (Tejedor y Fecha).</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        };


        // --- APP PRINCIPAL ---
        const App = () => {
            const [orders, setOrders] = useState([]);
            const [viewMode, setViewMode] = useState('active'); // 'active' o 'history'
            const [searchTerm, setSearchTerm] = useState('');

            // Cargar datos de Firebase
            useEffect(() => {
                const unsubscribe = db.collection('orders').onSnapshot(snap => {
                    const data = snap.docs.map(d => ({...d.data(), id: d.id})).sort((a, b) => b.fechaCreacion - a.fechaCreacion);
                    setOrders(data);
                });
                return () => unsubscribe();
            }, []);

            // Filtrar órdenes por modo y búsqueda
            const displayedOrders = useMemo(() => {
                let filtered = orders;
                
                if (viewMode === 'active') {
                    filtered = filtered.filter(o => o.status !== 'ARCHIVADO');
                } else if (viewMode === 'history') {
                    filtered = filtered.filter(o => o.status === 'ARCHIVADO');
                }

                if (searchTerm) {
                    const term = searchTerm.toLowerCase();
                    filtered = filtered.filter(o => 
                        o.modelo.toLowerCase().includes(term) ||
                        o.partida.toLowerCase().includes(term) ||
                        (o.cliente && o.cliente.toLowerCase().includes(term)) ||
                        String(o.id).includes(term)
                    );
                }
                
                return filtered;
            }, [orders, viewMode, searchTerm]);

            // --- FUNCIÓN DE ARCHIVO (Llamada desde ArchiveButton) ---
            const handleArchiveOrder = async (orderId, historyData) => {
                if (!confirm(`¿Estás seguro de archivar la orden ${orderId}?`)) return;

                try {
                    const orderDocRef = db.collection('orders').doc(orderId);
                    
                    await orderDocRef.update({
                        status: 'ARCHIVADO',
                        fechaArchivo: firebase.firestore.FieldValue.serverTimestamp(),
                        archiveHistory: historyData, // Aquí guardamos las fechas de escaneo e impresión
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    alert(`Orden ${orderId} archivada con éxito. Historial de escaneo guardado.`);
                } catch (error) {
                    console.error("Error al archivar la orden:", error);
                    alert("Error al archivar la orden: " + error.message);
                }
            };

            const handleOrderSelect = useCallback((order) => {
                const dashboardBottom = document.getElementById('dashboard-bottom-container');
                if (dashboardBottom) {
                    // Solo seleccionamos si no está archivada, para evitar edición
                    if (order.status !== 'ARCHIVADO') {
                        // Usamos la función de ArchiveButton para pasar la lógica de archivo
                        ReactDOM.render(<DashboardBottom activeOrders={orders} onArchiveOrder={handleArchiveOrder} />, dashboardBottom);
                    } else {
                        // Si está archivada, mostrar solo la vista
                        ReactDOM.render(<DashboardBottom activeOrders={orders} onArchiveOrder={handleArchiveOrder} />, dashboardBottom);
                    }
                    
                    // Asegurar que el componente se renderiza con la orden seleccionada
                    ReactDOM.render(<DashboardBottom activeOrders={orders} onArchiveOrder={handleArchiveOrder} selectedOrder={order}/>, dashboardBottom);

                }
            }, [orders]);


            return (
                <div className="h-screen flex flex-col overflow-hidden bg-slate-100">
                    
                    {/* Header */}
                    <header className="bg-white border-b border-slate-200 p-4 flex justify-between items-center shadow-md z-10">
                        <div className="flex items-center gap-3">
                            <div className="bg-slate-900 p-2 rounded-lg text-white shadow-lg">
                                <Icon name="box" size={24}/>
                            </div>
                            <div>
                                <h1 className="text-xl font-black text-slate-800 leading-none tracking-tight">GENERADOR DE ÓRDENES</h1>
                                <p className="text-xs text-slate-500 mt-1 font-bold">GESTIÓN Y LLENADO DIGITAL</p>
                            </div>
                        </div>
                        <div className="flex items-center gap-4">
                            <div className="relative">
                                <Icon name="search" size={16} className="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400"/>
                                <input 
                                    type="text"
                                    placeholder="Buscar Modelo, Partida o ID..."
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                    className="pl-10 pr-4 py-2 border border-slate-300 rounded-lg text-sm w-64 focus:outline-none focus:border-indigo-500"
                                />
                            </div>
                            <div className="flex bg-slate-200 rounded-lg p-1">
                                <button 
                                    onClick={() => setViewMode('active')}
                                    className={`px-3 py-1 text-sm font-bold rounded-lg transition ${viewMode === 'active' ? 'bg-indigo-600 text-white' : 'text-slate-600 hover:bg-slate-300'}`}
                                >
                                    <Icon name="zap" size={16} className="inline-block mr-1"/> Activas
                                </button>
                                <button 
                                    onClick={() => setViewMode('history')}
                                    className={`px-3 py-1 text-sm font-bold rounded-lg transition ${viewMode === 'history' ? 'bg-indigo-600 text-white' : 'text-slate-600 hover:bg-slate-300'}`}
                                >
                                    <Icon name="clock-3" size={16} className="inline-block mr-1"/> Historial
                                </button>
                            </div>
                        </div>
                    </header>

                    {/* Contenido Principal */}
                    <div className="flex-1 flex flex-col overflow-hidden">
                        
                        {/* SECCIÓN SUPERIOR: GRID DE ÓRDENES */}
                        <div className="overflow-y-auto flex-shrink-0" style={{ maxHeight: '40vh' }}>
                            <div className="grid-container">
                                {displayedOrders.map(o => (
                                    <OrderCard key={o.id} order={o} onSelect={handleOrderSelect} />
                                ))}
                                {displayedOrders.length === 0 && <div className="col-span-4 text-center text-slate-400 py-10 font-bold">No hay órdenes en esta vista.</div>}
                            </div>
                        </div>
                        
                        {/* SECCIÓN INFERIOR: DASHBOARD */}
                        <div id="dashboard-bottom-container" className="flex-1 flex overflow-hidden">
                             {/* Renderiza el componente DashboardBottom inicialmente vacío */}
                             <div className="w-1/3 p-4 border-r border-slate-200 bg-slate-50">
                                <h2 className="text-lg font-black text-slate-800 mb-4 border-b pb-2 flex items-center gap-2">
                                    <Icon name="layout-list" size={20}/> PROGRESO GENERAL
                                </h2>
                                <div className="text-center py-10 text-slate-400">
                                    <Icon name="mouse-pointer-2" size={32} className="mx-auto mb-2"/>
                                    <p className="text-sm">Selecciona una orden para ver su progreso detallado.</p>
                                </div>
                            </div>
                            <div className="w-2/3 p-4">
                                <h2 className="text-lg font-black text-slate-800 mb-4 border-b pb-2 flex items-center gap-2">
                                    <Icon name="pen-tool" size={20}/> LLENADO DIGITAL
                                </h2>
                                <div className="text-center py-20 text-slate-400">
                                    <Icon name="layout-sidebar-left-collapse" size={48} className="mx-auto mb-4"/>
                                    <p className="text-lg font-bold">Selecciona una tarjeta para ver el Llenado Digital.</p>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>