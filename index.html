<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Textil Cloud - Cirineo v3.3</title>
    
    <link id="appIcon" rel="icon" href="https://raw.githubusercontent.com/jesusvn1993mplvt3-ai/CIRINEO/refs/heads/main/icon.ico">
    <link id="appAppleIcon" rel="apple-touch-icon" href="https://raw.githubusercontent.com/jesusvn1993mplvt3-ai/CIRINEO/refs/heads/main/icon.ico">
    <meta name="theme-color" content="#1e293b">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        const manifest = {
            "name": "Sistema Textil Cloud",
            "short_name": "Cirineo",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#f1f5f9",
            "theme_color": "#1e293b",
            "icons": [{
                "src": "https://raw.githubusercontent.com/jesusvn1993mplvt3-ai/CIRINEO/refs/heads/main/icon.ico",
                "sizes": "192x192",
                "type": "image/ico"
            }]
        };
        const stringManifest = JSON.stringify(manifest);
        const blob = new Blob([stringManifest], {type: 'application/json'});
        const manifestURL = URL.createObjectURL(blob);
        const link = document.createElement('link');
        link.rel = 'manifest';
        link.href = manifestURL;
        document.head.appendChild(link);
    </script>

    <style>
        /* ESTILOS DE IMPRESIÓN GENERALES */
        @media print {
            body, html, #root { 
                background: white;
                -webkit-print-color-adjust: exact; 
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
            }
            .no-print, .dashboard-grid { display: none !important; }
            ::-webkit-scrollbar { display: none; }
        }

        /* ESTILO: CARTA VERTICAL (ORDEN NORMAL) */
        @media print {
            body:not(.print-mode-ticket) @page { 
                size: letter portrait; 
                margin: 1cm; 
            }
            body:not(.print-mode-ticket) .print-visible-wrapper {
                display: block !important;
                width: 100% !important;
            }
            body:not(.print-mode-ticket) .ticket-container {
                display: none !important;
            }
            
            /* Estilos específicos Carta */
            body:not(.print-mode-ticket) h1 { font-size: 36pt !important; line-height: 0.9 !important; margin-bottom: 5px; }
            body:not(.print-mode-ticket) table { border-collapse: collapse; width: 100%; border: 3px solid black; table-layout: fixed; margin-bottom: 8px; }
            body:not(.print-mode-ticket) th { background-color: #d1d5db !important; color: black !important; font-weight: 900 !important; font-size: 11pt !important; border: 2px solid black !important; }
            body:not(.print-mode-ticket) td { border: 2px solid black !important; padding: 4px !important; font-size: 12pt !important; font-weight: 700 !important; color: black !important; }
            body:not(.print-mode-ticket) .machine-number-val { font-size: 60pt !important; font-weight: 900; line-height: 0.8; }
            body:not(.print-mode-ticket) .print-only { display: block !important; }
        }

        /* ESTILO: PAPELETA 4x6 (ETIQUETAS) - REDISEÑADO */
        @media print {
            body.print-mode-ticket @page {
                size: 6in 4in landscape;
                margin: 0;
            }
            body.print-mode-ticket {
                width: 6in;
                height: 4in;
            }
            body.print-mode-ticket .print-visible-wrapper { display: none !important; } /* Ocultar carta */
            
            body.print-mode-ticket .ticket-container {
                display: flex !important;
                width: 6in;
                height: 4in;
                page-break-after: always;
                overflow: hidden;
                padding: 5px; /* Menor padding para aprovechar espacio */
                box-sizing: border-box;
                font-family: sans-serif;
                color: black;
            }
            body.print-mode-ticket .ticket-content {
                width: 100%;
                height: 100%;
                border: 3px solid black;
                border-radius: 8px;
                display: flex;
                flex-direction: column;
            }
            /* Clases utilitarias para la papeleta */
            .ticket-row { display: flex; border-bottom: 2px solid black; }
            .ticket-col { flex: 1; padding: 2px 4px; border-right: 2px solid black; display: flex; flex-direction: column; justify-content: center; }
            .ticket-col:last-child { border-right: none; }
            .ticket-label { font-size: 8pt; font-weight: bold; text-transform: uppercase; color: #333; line-height: 1; mb-0.5; }
            .ticket-value { font-size: 12pt; font-weight: 900; text-transform: uppercase; line-height: 1.1; word-break: break-word; }
            .ticket-value.large { font-size: 16pt; }
            .ticket-value.huge { font-size: 32pt; }
            .ticket-value.enormous { font-size: 48pt; color: #dc2626; } /* Rojo para máquina */
            
            .no-border-bottom { border-bottom: none !important; }
        }

        .print-only { display: none; }
        .ticket-container { display: none; } /* Oculto en pantalla normal */

        /* Dashboard Styles */
        .dashboard-grid { display: grid; grid-template-rows: 60vh 1fr; height: 100vh; overflow: hidden; }
        .top-pane { overflow-y: auto; border-bottom: 4px solid #334155; }
        .bottom-pane { overflow-x: auto; background: #1e293b; color: white; display: flex; padding: 10px; gap: 10px; }
        .machine-card { min-width: 320px; background: #334155; border-radius: 8px; padding: 10px; display: flex; flex-direction: column; height: 100%; }
        .pkg-list { overflow-y: auto; flex-grow: 1; margin-top: 10px; padding-right: 4px; }
        .pkg-list::-webkit-scrollbar { width: 6px; }
        .pkg-list::-webkit-scrollbar-thumb { background: #64748b; border-radius: 4px; }
        .obs-input { background: transparent; border: none; color: #cbd5e1; width: 100%; font-size: 10px; border-bottom: 1px solid #475569; }
        .obs-input:focus { outline: none; border-bottom: 1px solid #94a3b8; color: white; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        
        const firebaseConfig = {
            apiKey: "AIzaSyBqHgV4vDat1-VmZfKbiPg7nuiX-ROcexw",
            authDomain: "cirineo-cec21.firebaseapp.com",
            projectId: "cirineo-cec21",
            storageBucket: "cirineo-cec21.firebasestorage.app",
            messagingSenderId: "620210618284",
            appId: "1:620210618284:web:482bab9bf74650fff18409",
            measurementId: "G-B7YLM78RVW"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const Icon = ({ name, size = 18, className }) => <i data-lucide={name} width={size} height={size} className={className}></i>;
        const toUppercase = (handler) => (e) => { e.target.value = e.target.value.toUpperCase(); handler(e); };
        
        const generateSmartID = (partida, pieces, maquina) => {
            const piecePrefixes = pieces.map(p => p.pieza.substring(0, 2).toUpperCase()).join('/');
            return `${partida}-${piecePrefixes}-M${maquina}`;
        };

        // --- FUNCIÓN MODIFICADA: CODIGOS UNICOS SIN CONTADOR ---
        const generatePackages = (pieces, packageSize, partida) => {
            let packages = [];
            let pkgCounter = 1;
            pieces.forEach(p => {
                const total = Number(p.totalPedido) || 0;
                const size = Number(packageSize) || total;
                const n = Math.ceil(total / size);
                const codigoUnico = p.pieza.toUpperCase(); 

                for (let i = 1; i <= n; i++) {
                    const cantidad = (i === n) ? (total % size || size) : size;
                    
                    packages.push({ 
                        id: Date.now() + Math.random() + pkgCounter, 
                        piezaNombre: p.pieza, 
                        cantidad: cantidad, 
                        paqueteNum: i, 
                        paquetesDePieza: n, 
                        codigoUnico: codigoUnico, 
                        finished: false 
                    });
                    pkgCounter++;
                }
            });
            return packages;
        };

        // --- HOOK PARA ESCÁNER DE CÓDIGO DE BARRAS ---
        const useBarcodeScanner = (onScan) => {
            useEffect(() => {
                let buffer = '';
                let lastKeyTime = Date.now();

                const handleKeyDown = (e) => {
                    const target = e.target;
                    if (target.tagName === 'INPUT' || target.tagName === 'TEXTAREA') return;

                    const char = e.key;
                    const currentTime = Date.now();

                    if (currentTime - lastKeyTime > 100) {
                        buffer = '';
                    }
                    lastKeyTime = currentTime;

                    if (char === 'Enter') {
                        if (buffer.length > 5) {
                            onScan(buffer);
                        }
                        buffer = '';
                    } else if (char.length === 1) {
                        buffer += char;
                    }
                };

                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [onScan]);
        };

        // --- COMPONENTE PAPELETA INDIVIDUAL (4x6) ---
        const PackageTicket = ({ order, pkg }) => {
            const canvasRef = useRef(null);
            const pieceInfo = order.subPiecesData?.find(p => p.pieza === pkg.piezaNombre) || {};
            
            useEffect(() => {
                if (canvasRef.current) {
                    const barcodeValue = `${order.id}-${pkg.id}`;
                    try {
                        JsBarcode(canvasRef.current, barcodeValue, {
                            format: "CODE128",
                            displayValue: false,
                            height: 50,
                            width: 2,
                            margin: 0,
                            background: "transparent"
                        });
                    } catch (e) {
                        console.error("Error barcode", e);
                    }
                }
            }, [order, pkg]);

            return (
                <div className="ticket-container">
                    <div className="ticket-content">
                        <div className="ticket-row" style={{flex: '0 0 auto'}}>
                            <div className="ticket-col" style={{flex: 2}}>
                                <span className="ticket-label">MODELO</span>
                                <span className="ticket-value large">{order.codigo}</span>
                            </div>
                            <div className="ticket-col" style={{flex: 1}}>
                                <span className="ticket-label">PIEZAS</span>
                                <span className="ticket-value large text-center">{pkg.cantidad}</span>
                            </div>
                            <div className="ticket-col" style={{flex: 2}}>
                                <span className="ticket-label">PARTIDA</span>
                                <span className="ticket-value large">{order.partida}</span>
                            </div>
                            <div className="ticket-col" style={{flex: 3}}>
                                <span className="ticket-label">CLIENTE</span>
                                <span className="ticket-value large truncate">{order.cliente}</span>
                            </div>
                        </div>
                        <div className="ticket-row" style={{flex: '0 0 auto', padding: '4px'}}>
                            <div className="ticket-col border-r-0">
                                <span className="ticket-label">DESCRIPCION</span>
                                <span className="ticket-value text-lg leading-tight">{pkg.piezaNombre}</span>
                            </div>
                        </div>
                        <div className="ticket-row" style={{flex: '1 1 auto'}}>
                            <div className="ticket-col text-center" style={{flex: 1}}>
                                <span className="ticket-label">NUMERO DE COSTURA</span>
                                <span className="ticket-value huge">{pkg.paqueteNum}</span>
                                <span className="text-xs font-bold">DE {pkg.paquetesDePieza}</span>
                            </div>
                            <div className="ticket-col text-center" style={{flex: 1.5}}>
                                <span className="ticket-label">PIEZAS X COSTURA</span>
                                <span className="ticket-value huge">{pkg.cantidad}</span>
                            </div>
                            <div className="ticket-col text-center bg-slate-100" style={{flex: 1}}>
                                <span className="ticket-label">MAQUINA</span>
                                <span className="ticket-value enormous">{order.maquina}</span>
                            </div>
                        </div>
                        <div className="ticket-row" style={{flex: '0 0 auto', fontSize: '9pt'}}>
                             <div className="ticket-col" style={{flex: 1}}>
                                <span className="ticket-label">TALLA</span>
                                <span className="ticket-value">{pieceInfo.talla || '-'}</span>
                            </div>
                            <div className="ticket-col" style={{flex: 2}}>
                                <span className="ticket-label">MATERIALES</span>
                                <div className="flex flex-col">
                                    {order.threading?.map((h, i) => (
                                        h.material && <span key={i} className="font-bold text-xs truncate">{h.material}</span>
                                    ))}
                                </div>
                            </div>
                             <div className="ticket-col" style={{flex: 1.5}}>
                                <div className="border-b-2 border-black mb-1 pb-1">
                                     <span className="ticket-label">FECHA ENTREGA</span>
                                     <span className="ticket-value text-sm block">{new Date().toLocaleDateString('es-MX')}</span>
                                </div>
                                <div>
                                     <span className="ticket-label">TEJIDO POR:</span>
                                     <span className="block border-b border-black h-4"></span>
                                </div>
                            </div>
                        </div>
                        <div className="ticket-row no-border-bottom flex-col items-center justify-center pt-2" style={{flex: '0 0 auto'}}>
                            <canvas ref={canvasRef} className="max-w-full"></canvas>
                            <div className="text-[9px] font-mono text-center w-full leading-none mt-1">
                                {pkg.codigoUnico}
                            </div>
                            <div className="text-[8px] font-mono text-center w-full leading-none text-slate-500">
                                ID: {order.id}-{pkg.id}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- DASHBOARD COMPONENTS ---
        const InstallButton = () => {
             const [deferredPrompt, setDeferredPrompt] = useState(null);
            useEffect(() => {
                const handler = (e) => { e.preventDefault(); setDeferredPrompt(e); };
                window.addEventListener('beforeinstallprompt', handler);
                return () => window.removeEventListener('beforeinstallprompt', handler);
            }, []);
            const handleInstall = async () => {
                if (!deferredPrompt) return;
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') setDeferredPrompt(null);
            };
            if (!deferredPrompt) return null;
            return (
                <button onClick={handleInstall} className="bg-yellow-500 hover:bg-yellow-600 text-black px-3 py-2 rounded font-bold shadow flex items-center gap-2 text-xs animate-pulse">
                    <Icon name="download-cloud" size={16}/> INSTALAR APP
                </button>
            );
        };

        const MachineCard = ({ maquina, orders }) => {
            const [is24Hours, setIs24Hours] = useState(true);
            const pendingPackages = useMemo(() => {
                let pkgs = [];
                orders.forEach(o => {
                    const incomplete = o.progreso?.filter(p => !p.finished) || [];
                    incomplete.forEach(p => {
                        const pieceData = o.subPiecesData?.find(sp => sp.pieza === p.piezaNombre) || o;
                        const timePerPiece = Number(pieceData.tiempo) || 0;
                        pkgs.push({ ...p, parentOrderId: o.id, orderCode: o.codigo, partida: o.partida, timeTotal: (p.cantidad * timePerPiece) });
                    });
                });
                return pkgs; 
            }, [orders]);

            const updateObs = async (pkgId, parentOrderId, newVal) => {
                const order = orders.find(o => o.id === parentOrderId);
                if(!order) return;
                const newProgreso = order.progreso.map(p => p.id === pkgId ? {...p, observaciones: newVal} : p);
                await db.collection('orders').doc(String(parentOrderId)).update({progreso: newProgreso});
            };

            const totalMinutesLeft = pendingPackages.reduce((sum, p) => sum + p.timeTotal, 0);
            const hoursPerDay = is24Hours ? 24 : 12;
            const daysLeft = totalMinutesLeft > 0 ? (totalMinutesLeft / 60 / hoursPerDay).toFixed(1) : 0;
            const hoursLeft = (totalMinutesLeft / 60).toFixed(1);

            return (
                <div className="machine-card shadow-lg border border-slate-600">
                    <div className="flex justify-between items-center border-b border-slate-500 pb-2 mb-2">
                        <div>
                            <div className="text-xs text-slate-400 font-bold uppercase">Máquina</div>
                            <div className="text-3xl font-black text-yellow-400">#{maquina}</div>
                        </div>
                        <div className="text-right">
                            <button onClick={()=>setIs24Hours(!is24Hours)} className="bg-slate-700 hover:bg-slate-600 px-2 py-1 rounded text-[10px] font-bold mb-1 border border-slate-500 block w-full">
                                {is24Hours ? '24 HORAS' : '12 HORAS'}
                            </button>
                            <div className="text-xs font-bold text-green-400">{daysLeft} días ({hoursLeft}h)</div>
                        </div>
                    </div>
                    <div className="pkg-list space-y-1">
                        {pendingPackages.length === 0 && <div className="text-center text-slate-500 text-xs py-4">Máquina Libre</div>}
                        {pendingPackages.map((p, i) => (
                            <div key={i} className="bg-slate-800 p-2 rounded flex gap-2 items-center text-xs border border-slate-700">
                                <div className="font-black text-white text-lg w-10 text-right shrink-0">{p.cantidad}</div>
                                <div className="w-24 shrink-0 overflow-hidden">
                                    <div className="font-bold text-slate-300 truncate text-[10px]" title={p.piezaNombre}>{p.piezaNombre}</div>
                                    <div className="text-[9px] text-yellow-500 font-black truncate">{p.partida}</div>
                                </div>
                                <div className="flex-grow pl-2 border-l border-slate-600">
                                    <input className="obs-input placeholder-slate-600" placeholder="Observaciones..." defaultValue={p.observaciones || ''} onBlur={(e) => updateObs(p.id, p.parentOrderId, e.target.value)} onKeyDown={(e) => { if(e.key === 'Enter') e.target.blur(); }}/>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const DashboardBottom = ({ activeOrders }) => {
            const machineGroups = useMemo(() => {
                const groups = {};
                activeOrders.forEach(o => { if(!groups[o.maquina]) groups[o.maquina] = []; groups[o.maquina].push(o); });
                return Object.keys(groups).sort((a,b) => parseInt(a)-parseInt(b)).map(k => ({ id: k, orders: groups[k] }));
            }, [activeOrders]);

            return (
                <div className="bottom-pane shadow-inner">
                    {machineGroups.map(g => <MachineCard key={g.id} maquina={g.id} orders={g.orders} />)}
                    {machineGroups.length === 0 && <div className="text-slate-500 w-full flex items-center justify-center font-bold">No hay producción activa</div>}
                </div>
            );
        };

        // --- COMPONENTE DE IMPORTACIÓN ACTUALIZADO ---
        const ImportModal = ({ onClose, onImport }) => {
            const [text, setText] = useState('');
            const [error, setError] = useState(null);

            const handleProcess = () => {
                if (!text.trim()) return;
                try {
                    const delimiter = text.includes('\t') ? '\t' : ',';
                    const rows = text.trim().split('\n').map(r => r.split(delimiter));
                    if (rows.length < 2) throw new Error("Datos insuficientes.");
                    
                    // Limpieza de cabeceras
                    const headers = rows[0].map(h => h.trim().toUpperCase().replace(/"/g, ''));
                    const getVal = (row, colName) => { 
                        const idx = headers.indexOf(colName); 
                        return idx !== -1 && row[idx] ? row[idx].trim().replace(/"/g, '') : ''; 
                    };

                    // Validar columnas críticas del nuevo formato
                    if (headers.indexOf('PARTIDA') === -1) throw new Error("Falta columna 'PARTIDA'");
                    if (headers.indexOf('MODELO') === -1) throw new Error("Falta columna 'MODELO'");
                    if (headers.indexOf('PIEZAS') === -1) throw new Error("Falta columna 'PIEZAS'");
                    if (headers.indexOf('PESO') === -1) throw new Error("Falta columna 'PESO' (Peso por pieza)");
                    if (headers.indexOf('TIEMPO') === -1) throw new Error("Falta columna 'TIEMPO' (Minutos por pieza)");

                    const firstRow = rows[1];
                    const predefinedPackages = [];
                    const piecesMap = {}; // Mapa para agrupar por DESCRIPCION

                    // Recorrer filas de datos
                    const dataRows = rows.slice(1).filter(r => r.some(c => c.trim() !== ''));
                    if (dataRows.length === 0) throw new Error("No se encontraron filas de datos válidas.");

                    dataRows.forEach((r, i) => {
                        const descripcion = getVal(r, 'DESCRIPCION') || 'ESTANDAR';
                        const piezas = parseFloat(getVal(r, 'PIEZAS')) || 0;
                        const peso = parseFloat(getVal(r, 'PESO')) || 0;
                        const tiempo = parseFloat(getVal(r, 'TIEMPO')) || 0;
                        const talla = getVal(r, 'TALLA') || 'UNITALLA';
                        const codigoUnico = getVal(r, 'CODIGO');
                        // Intenta parsear la costura (ej: "1_5" -> 1), si no hay o falla usa el índice
                        const costuraStr = getVal(r, 'COSTURA');
                        const paqueteNum = parseInt(costuraStr.split('_')[0]) || (i + 1); 

                        // 1. Crear Paquete Individual
                        if (piezas > 0) {
                            predefinedPackages.push({ 
                                id: Date.now() + i, 
                                piezaNombre: descripcion, 
                                cantidad: piezas, 
                                paqueteNum: paqueteNum,
                                paquetesDePieza: 0, 
                                codigoUnico: codigoUnico, 
                                finished: false 
                            });
                        }

                        // 2. Agrupar para SubPiecesData (Resumen de la orden)
                        if (!piecesMap[descripcion]) {
                            piecesMap[descripcion] = {
                                id: Date.now() + i + 5000,
                                pieza: descripcion,
                                programa: '',
                                talla: talla,
                                totalPedido: 0,
                                peso: peso, 
                                tiempo: tiempo 
                            };
                        }
                        piecesMap[descripcion].totalPedido += piezas;
                    });
                    
                    // Contar el total de paquetes por descripcion para 'paquetesDePieza'
                    const packageCountMap = predefinedPackages.reduce((acc, p) => {
                        acc[p.piezaNombre] = (acc[p.piezaNombre] || 0) + 1;
                        return acc;
                    }, {});

                    // Asignar el total de paquetes de la pieza
                    const finalPackages = predefinedPackages.map(p => ({
                        ...p,
                        paquetesDePieza: packageCountMap[p.piezaNombre]
                    }));

                    // Convertir el mapa a array
                    const subPiecesData = Object.values(piecesMap);

                    // Preparar Enhebrado vacío (el usuario lo llenará manual)
                    const threading = [];
                    
                    onImport({ 
                        codigo: getVal(firstRow, 'MODELO'), 
                        cliente: getVal(firstRow, 'CLIENTE'), 
                        maquina: getVal(firstRow, 'MAQUINA'), 
                        partida: getVal(firstRow, 'PARTIDA'), 
                        subPiecesData: subPiecesData, 
                        threading: threading, 
                        predefinedPackages: finalPackages,
                        createdAt: new Date().toLocaleString('es-MX')
                    });
                } catch (e) { setError(e.message); console.error("Import Error:", e); }
            };

            return (
                <div className="fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-4">
                    <div className="bg-white p-6 rounded-lg shadow-2xl w-full max-w-2xl relative">
                        <div className="flex justify-between items-center mb-4 border-b pb-2">
                            <h3 className="font-bold text-xl text-green-700 flex items-center gap-2"><Icon name="file-spreadsheet"/> Importar CSV Producción</h3>
                            <button onClick={onClose} className="bg-red-500 hover:bg-red-600 text-white rounded-md p-2 shadow-lg flex items-center gap-1 font-bold text-xs transition-transform hover:scale-105">
                                <Icon name="x" size={18}/> CERRAR
                            </button>
                        </div>
                        <p className="text-xs text-slate-500 mb-2">Copia y pega las celdas desde tu Excel (Incluyendo cabeceras: PARTIDA, MODELO, PIEZAS, PESO, TIEMPO, etc).</p>
                        <textarea value={text} onChange={(e) => { setText(e.target.value); setError(null); }} className="w-full h-64 p-3 border-2 border-slate-300 rounded font-mono text-[10px] focus:border-green-500 focus:outline-none" placeholder="Pegar datos..."></textarea>
                        {error && <div className="mt-2 text-red-600 text-xs font-bold bg-red-50 p-2 rounded border border-red-200">Error: {error}</div>}
                        <div className="flex justify-end gap-2 mt-4">
                            <button onClick={handleProcess} className="px-6 py-2 bg-green-600 text-white font-bold rounded shadow hover:bg-green-700 flex items-center gap-2"><Icon name="check-circle" size={18}/> Procesar Datos</button>
                        </div>
                    </div>
                </div>
            );
        };

        const SmartImage = ({ repoUrls, codigo, className }) => {
             const [imgSrc, setImgSrc] = useState(null);
            const [attempt, setAttempt] = useState({ urlIndex: 0, extension: 'jpg' });
            useEffect(() => {
                if (!repoUrls || !repoUrls.length || !codigo) { setImgSrc(null); return; }
                setAttempt({ urlIndex: 0, extension: 'jpg' });
                const base = repoUrls[0].endsWith('/') ? repoUrls[0] : repoUrls[0] + '/';
                setImgSrc(`${base}${codigo}.jpg`);
            }, [repoUrls, codigo]);

            const handleError = () => {
                const { urlIndex, extension } = attempt;
                if (extension === 'jpg') {
                    const base = repoUrls[urlIndex].endsWith('/') ? repoUrls[urlIndex] : repoUrls[urlIndex] + '/';
                    setImgSrc(`${base}${codigo}.png`);
                    setAttempt({ ...attempt, extension: 'png' });
                } else if (urlIndex < repoUrls.length - 1) {
                    const nextIdx = urlIndex + 1;
                    const base = repoUrls[nextIdx].endsWith('/') ? repoUrls[nextIdx] : repoUrls[nextIdx] + '/';
                    setImgSrc(`${base}${codigo}.jpg`);
                    setAttempt({ urlIndex: nextIdx, extension: 'jpg' });
                } else {
                    setAttempt({ ...attempt, extension: 'fail' });
                }
            };
            if (attempt.extension === 'fail' || !imgSrc) return <div className={`bg-slate-100 flex flex-col items-center justify-center text-slate-300 ${className}`}><Icon name="image-off" size={32} className="mb-2"/><span className="text-[10px] text-center px-2">Sin img</span></div>;
            return <img src={imgSrc} onError={handleError} className={className} />;
        };

        // --- EDITOR DE ENHEBRADO OPTIMIZADO Y SIMPLIFICADO ---
        const ThreadingEditor = ({ data, onChange, inventoryItems, totalWeight }) => {
            const addRow = () => onChange([...data, { id: Date.now(), material: '', porcentaje: '' }]);
            const updateRow = (id, field, val) => onChange(data.map(r => r.id === id ? { ...r, [field]: val } : r));
            const removeRow = (id) => onChange(data.filter(r => r.id !== id));
            
            const invList = Array.isArray(inventoryItems) ? inventoryItems : [];
            const totalPercentage = data.reduce((sum, r) => sum + (parseFloat(r.porcentaje) || 0), 0);
            
            return (
                <div className="border rounded bg-white overflow-hidden my-4 shadow-sm">
                    <div className="bg-slate-800 text-white p-2 text-xs font-bold flex justify-between items-center">
                        <span className="flex items-center gap-2"><Icon name="spool" size={14}/> CONSUMO DE HILATURAS</span>
                        <div className="text-[10px] font-normal opacity-80">Peso Orden Total: <b>{(totalWeight/1000).toFixed(2)} Kg</b></div>
                        <button onClick={addRow} className="text-slate-900 font-bold bg-yellow-400 hover:bg-yellow-500 px-2 py-0.5 rounded text-[10px] shadow-sm flex items-center gap-1">+ HILO</button>
                    </div>
                    <div className={`p-1 ${data.length > 6 ? 'h-64 overflow-y-auto' : ''}`}> {/* Optimización para 6+ filas */}
                        <table className="w-full text-xs text-left">
                            <thead className="bg-slate-100 border-b text-slate-500">
                                <tr>
                                    <th className="p-1 pl-2 w-1/2">HILATURA</th>
                                    <th className="p-1 w-1/4 text-center">PORCENTAJE</th>
                                    <th className="p-1 w-1/4 text-center">CONSUMO (Kg)</th>
                                    <th className="w-6"></th>
                                </tr>
                            </thead>
                            <tbody>
                                {data.map((row) => {
                                    const pct = parseFloat(row.porcentaje) || 0;
                                    const requiredKg = (totalWeight * (pct / 100)) / 1000;

                                    return (
                                        <tr key={row.id} className="border-b hover:bg-slate-50">
                                            <td className="p-1 pl-2">
                                                <input list="inv" className="w-full border-b border-transparent hover:border-slate-300 focus:border-indigo-500 bg-transparent p-0.5 font-bold text-slate-700 outline-none" value={row.material} onChange={toUppercase(e=>updateRow(row.id,'material',e.target.value))} placeholder="Nombre del hilo"/>
                                            </td>
                                            <td className="p-1">
                                                <input type="number" min="0" max="100" className="w-full bg-slate-50 border rounded p-0.5 text-center font-bold text-indigo-700 focus:bg-white focus:ring-1 focus:ring-indigo-500 outline-none" value={row.porcentaje} onChange={e=>updateRow(row.id,'porcentaje',e.target.value)} placeholder="0"/>
                                            </td>
                                            <td className="p-1 text-center font-black text-slate-800 bg-indigo-50/50">
                                                {requiredKg > 0 ? requiredKg.toFixed(2) : '0.00'}
                                            </td>
                                            <td className="p-1 text-center">
                                                <button onClick={()=>removeRow(row.id)} className="text-red-300 hover:text-red-600 transition-colors"><Icon name="x" size={14}/></button>
                                            </td>
                                        </tr>
                                    );
                                })}
                                {data.length === 0 && (
                                    <tr>
                                        <td colSpan="4" className="text-center py-4 text-slate-400 text-[10px] italic">
                                            No hay hilos configurados. Agrega materiales.
                                        </td>
                                    </tr>
                                )}
                            </tbody>
                            <tfoot className="bg-slate-200 font-bold text-sm">
                                <tr>
                                    <td className="p-1 pl-2 text-right">TOTAL:</td>
                                    <td className="p-1 text-center text-indigo-700">{totalPercentage.toFixed(2)} %</td>
                                    <td className="p-1 text-center">{((totalWeight * totalPercentage / 100) / 1000).toFixed(2)} Kg</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    <datalist id="inv">
                        {invList.map((item, idx) => (
                            <option key={idx} value={item.material}></option>
                        ))}
                    </datalist>
                </div>
            );
        };
        
        const MultiOrderForm = ({ config, onCancel, initialOrder, clientHistory, inventory, isEditing }) => {
             const [header, setHeader] = useState(initialOrder ? { codigo: initialOrder.codigo, cliente: initialOrder.cliente, maquina: initialOrder.maquina, partida: initialOrder.partida || '', fechaInicio: initialOrder.fechaInicio || new Date().toISOString().split('T')[0] } : { codigo: '', cliente: '', maquina: '', partida: '', fechaInicio: new Date().toISOString().split('T')[0] });
            const [pieces, setPieces] = useState(initialOrder?.subPiecesData || [{ id: 1, pieza: 'BLUSA', programa: '', talla: 'UNITALLA', totalPedido: 100, peso: '150', tiempo: '' }]);
            const [threadingData, setThreadingData] = useState(initialOrder?.threading || []);
            const predefinedPackages = initialOrder?.predefinedPackages || (initialOrder && initialOrder.packageSize === 'VARIO' ? initialOrder.progreso : null);
            const [packageSize, setPackageSize] = useState(initialOrder?.packageSize && initialOrder.packageSize !== 'VARIO' ? initialOrder.packageSize : 50);
            
            const addPiece = () => setPieces([...pieces, { id: Date.now(), pieza: '', talla: 'UNITALLA', totalPedido: '', peso: '', tiempo: '' }]);
            const updatePiece = (id, f, v) => setPieces(pieces.map(p => p.id === id ? { ...p, [f]: v } : p));
            const removePiece = (id) => pieces.length > 1 && setPieces(pieces.filter(p => p.id !== id));
            
            const totalOrderWeight = pieces.reduce((sum, p) => sum + ((Number(p.totalPedido) || 0) * (Number(p.peso) || 0)), 0);

            const handleSubmit = async () => {
                if(!header.codigo || !header.cliente || !header.maquina || !header.partida) return alert("Faltan datos.");
                let finalPackages = initialOrder?.progreso?.filter(p => p.finished) || []; 
                if (predefinedPackages) {
                    if (isEditing) {
                        const newPredefined = initialOrder.progreso.map(p => {
                            const original = initialOrder.progreso.find(op => op.id === p.id);
                            return {...p, finished: original?.finished || false, tejedor: original?.tejedor || '', fecha: original?.fecha || '', defectos: original?.defectos || '', agujas: original?.agujas || ''};
                        });
                        finalPackages = newPredefined;
                    } else {
                        finalPackages = predefinedPackages;
                    }
                } else {
                    const newPackages = generatePackages(pieces, packageSize, header.partida);
                    if(isEditing) {
                         const finishedIds = new Set(finalPackages.map(p=>p.id));
                         finalPackages = [...finalPackages, ...newPackages.filter(p=>!finishedIds.has(p.id))];
                    } else {
                         finalPackages = newPackages;
                    }
                }

                if (inventory && Array.isArray(inventory)) {
                    let updatedInventoryItems = [...inventory]; 
                    let inventoryChanged = false;
                    if (isEditing && initialOrder) {
                        const oldTotalWeight = initialOrder.subPiecesData.reduce((sum, p) => sum + ((Number(p.totalPedido)||0) * (Number(p.peso)||0)), 0);
                        const oldTotalKg = oldTotalWeight / 1000;
                        initialOrder.threading.forEach(row => {
                            const pct = parseFloat(row.porcentaje) || 0;
                            if (pct > 0 && row.material) {
                                const consumedKg = oldTotalKg * (pct / 100);
                                const itemIndex = updatedInventoryItems.findIndex(i => i.material === row.material);
                                if (itemIndex > -1) {
                                    const currentStock = parseFloat(updatedInventoryItems[itemIndex].stock) || 0;
                                    updatedInventoryItems[itemIndex] = { ...updatedInventoryItems[itemIndex], stock: (currentStock + consumedKg).toFixed(2) };
                                    inventoryChanged = true;
                                }
                            }
                        });
                    }
                    const newTotalKg = totalOrderWeight / 1000;
                    threadingData.forEach(row => {
                        const pct = parseFloat(row.porcentaje) || 0;
                        if (pct > 0 && row.material) {
                            const consumedKg = newTotalKg * (pct / 100);
                            const itemIndex = updatedInventoryItems.findIndex(i => i.material === row.material);
                            if (itemIndex > -1) {
                                const currentStock = parseFloat(updatedInventoryItems[itemIndex].stock) || 0;
                                const newStock = Math.max(0, currentStock - consumedKg);
                                updatedInventoryItems[itemIndex] = { ...updatedInventoryItems[itemIndex], stock: newStock.toFixed(2) };
                                inventoryChanged = true;
                            }
                        }
                    });

                    if (inventoryChanged) {
                        try {
                            await db.collection('inventory').doc('main').update({ items: updatedInventoryItems });
                        } catch (err) { alert("Advertencia: Hubo un error sincronizando el inventario."); }
                    }
                }

                const displayId = generateSmartID(header.partida, pieces, header.maquina);
                const creationDate = isEditing ? (initialOrder.createdAt || new Date().toLocaleString('es-MX')) : (initialOrder?.createdAt || new Date().toLocaleString('es-MX'));

                const orderPayload = { 
                    ...header, 
                    id: isEditing ? initialOrder.id : Date.now(), 
                    displayId, 
                    subPiecesData: pieces.map(p => ({...p, totalPedido: Number(p.totalPedido), peso: Number(p.peso)})), 
                    progreso: finalPackages, 
                    threading: threadingData, 
                    packageSize: predefinedPackages ? 'VARIO' : Number(packageSize), 
                    status: initialOrder?.status || 'EN PROCESO', 
                    totalPedido: pieces.reduce((a,b)=>a+Number(b.totalPedido),0),
                    createdAt: creationDate
                };
                try { 
                    await db.collection('orders').doc(String(orderPayload.id)).set(orderPayload);
                    alert(`Orden ${isEditing ? 'Actualizada' : 'Guardada'} y el Inventario ha sido ajustado.`);
                    onCancel(); 
                } catch(e) { 
                    console.error(e);
                    alert("Error al guardar"); 
                }
            };
            
            return (
                <div className="bg-white p-6 rounded shadow-xl max-w-4xl mx-auto my-4 overflow-y-auto h-[90vh]">
                    <div className="flex justify-between items-center mb-4 border-b pb-2">
                        <h2 className="font-bold text-xl flex items-center gap-2">
                             <Icon name={isEditing ? "file-edit" : "file-plus"}/> {isEditing ? 'Editar Orden' : 'Nueva Orden'}
                        </h2>
                        <button onClick={onCancel} className="text-red-500 font-bold">Cancelar</button>
                    </div>
                    <div className="grid grid-cols-12 gap-4 mb-4">
                        <div className="col-span-3 bg-yellow-50 p-2 rounded border border-yellow-200"><label className="text-xs font-bold text-yellow-900">PARTIDA</label><input value={header.partida} onChange={toUppercase(e=>setHeader({...header, partida:e.target.value}))} className="w-full text-lg font-black p-1 bg-white border rounded uppercase" placeholder="Ej: 24NOV451" disabled={isEditing}/></div>
                        <div className="col-span-3"><label className="text-xs font-bold">MODELO (FOTO)</label><input value={header.codigo} onChange={toUppercase(e=>setHeader({...header, codigo:e.target.value}))} className="w-full border p-2 rounded font-bold uppercase"/></div>
                        <div className="col-span-4"><label className="text-xs font-bold">CLIENTE</label><input list="clients" value={header.cliente} onChange={toUppercase(e=>setHeader({...header, cliente:e.target.value}))} className="w-full border p-2 rounded font-bold"/><datalist id="clients">{clientHistory.map(c=><option key={c} value={c}/>)}</datalist></div>
                        <div className="col-span-2"><label className="text-xs font-bold bg-slate-200 px-1">MÁQUINA</label><input value={header.maquina} onChange={toUppercase(e=>setHeader({...header, maquina:e.target.value}))} className="w-full border-2 border-slate-400 p-2 rounded font-black text-center"/></div>
                    </div>

                    <div className="mb-4 bg-slate-50 p-3 rounded">
                        <h3 className="font-bold text-sm mb-2 flex items-center gap-2"><Icon name="layers"/> Piezas / Detalles</h3>
                        {pieces.map((p, i) => (
                            <div key={p.id} className="grid grid-cols-12 gap-2 mb-2 items-end border-b pb-2">
                                <div className="col-span-3"><label className="text-[10px] font-bold">Nombre/Desc</label><input value={p.pieza} onChange={toUppercase(e=>updatePiece(p.id,'pieza',e.target.value))} className="w-full border p-1 rounded font-bold text-sm"/></div>
                                <div className="col-span-2"><label className="text-[10px] font-bold">Talla</label><input value={p.talla} onChange={toUppercase(e=>updatePiece(p.id,'talla',e.target.value))} className="w-full border p-1 rounded text-xs"/></div>
                                <div className="col-span-2"><label className="text-[10px] font-bold">Cant. Total</label><input type="number" value={p.totalPedido} onChange={e=>updatePiece(p.id,'totalPedido',e.target.value)} className="w-full border p-1 font-bold text-indigo-700" disabled={!!predefinedPackages}/></div>
                                <div className="col-span-2 bg-indigo-50 px-1 rounded"><label className="text-[10px] font-bold text-indigo-800">Peso (g)</label><input type="number" value={p.peso} onChange={e=>updatePiece(p.id,'peso',e.target.value)} className="w-full border p-1 text-center font-bold" placeholder="Gramos"/></div>
                                <div className="col-span-2"><label className="text-[10px] font-bold">Minutos/Pza</label><input type="number" value={p.tiempo} onChange={e=>updatePiece(p.id,'tiempo',e.target.value)} className="w-full border p-1 bg-yellow-50" placeholder="Calc. Tiempo"/></div>
                                <div className="col-span-1 text-center"><button onClick={()=>removePiece(p.id)} className="text-red-500" disabled={!!predefinedPackages}><Icon name="x"/></button></div>
                            </div>
                        ))}
                        {!predefinedPackages && <button onClick={addPiece} className="text-xs font-bold text-indigo-600">+ Agregar Pieza</button>}
                        {predefinedPackages && <div className="text-xs text-green-600 font-bold mt-2"><Icon name="check"/> Paquetes cargados desde Excel ({predefinedPackages.length} filas)</div>}
                    </div>

                    <ThreadingEditor data={threadingData} onChange={setThreadingData} inventoryItems={inventory} totalWeight={totalOrderWeight} />

                    <div className="flex gap-4 mt-4">
                        {!predefinedPackages && <div className="w-32"><label className="text-xs font-bold">Pzs/Paquete</label><input type="number" value={packageSize} onChange={e=>setPackageSize(e.target.value)} className="border p-2 rounded w-full"/></div>}
                        <button onClick={handleSubmit} className="flex-1 bg-slate-900 text-white font-bold rounded shadow hover:bg-slate-800 py-3">{isEditing ? 'GUARDAR CAMBIOS' : 'CREAR ORDEN Y AJUSTAR INVENTARIO'}</button>
                    </div>
                </div>
            );
        };

        // --- VISUALIZACIÓN E IMPRESIÓN ---
        const OrderView = ({ order, config, onBack, onEdit }) => {
            const [entry, setEntry] = useState({ tejedor: '', fecha: new Date().toISOString().split('T')[0], defectos: '', agujas: '' });
            const [selectedPackage, setSelectedPackage] = useState(null);
            const [isTicketPrinting, setIsTicketPrinting] = useState(false);

            const totalPieces = useMemo(() => order.subPiecesData.reduce((sum, p) => sum + Number(p.totalPedido), 0), [order]);
            const totalWeightKg = useMemo(() => order.subPiecesData.reduce((sum, p) => sum + (Number(p.totalPedido) * Number(p.peso)), 0) / 1000, [order]);
            const totalTimeMinutes = useMemo(() => order.subPiecesData.reduce((sum, p) => sum + (Number(p.totalPedido) * Number(p.tiempo)), 0), [order]);
            
            const totalPackages = order.progreso.length;
            const finishedPackages = order.progreso.filter(p => p.finished).length;
            const pendingPackages = totalPackages - finishedPackages;
            const progressPct = totalPackages > 0 ? (finishedPackages / totalPackages) * 100 : 0;
            const packagesGrouped = useMemo(() => {
                const groups = {};
                order.progreso.forEach(pkg => {
                    const pieceName = pkg.piezaNombre;
                    if (!groups[pieceName]) groups[pieceName] = [];
                    groups[pieceName].push(pkg);
                });
                return groups;
            }, [order.progreso]);


            const handleScan = (barcode) => {
                // El barcode es OrderID-PackageID
                const parts = barcode.split('-');
                if (parts.length !== 2) return;
                const pkgId = Number(parts[1]);

                const pkgToUpdate = order.progreso.find(p => p.id === pkgId);
                if (pkgToUpdate) {
                    setSelectedPackage(pkgToUpdate);
                    if (pkgToUpdate.finished) {
                        alert(`El paquete #${pkgToUpdate.paqueteNum} ya está terminado.`);
                    }
                } else {
                    alert('Paquete no encontrado.');
                }
            };

            useBarcodeScanner(handleScan);

            const handleFinishPackage = async () => {
                if(!selectedPackage) return;
                if(!entry.tejedor || !entry.fecha) return alert("Ingrese Tejedor y Fecha.");

                const updatedProgreso = order.progreso.map(p => 
                    p.id === selectedPackage.id 
                        ? { 
                            ...p, 
                            finished: true, 
                            tejedor: entry.tejedor.toUpperCase(), 
                            fecha: entry.fecha, 
                            defectos: entry.defectos, 
                            agujas: entry.agujas 
                        } 
                        : p
                );
                
                const newStatus = updatedProgreso.every(p => p.finished) ? 'TERMINADO' : order.status;

                try {
                    await db.collection('orders').doc(String(order.id)).update({
                        progreso: updatedProgreso,
                        status: newStatus
                    });
                    setSelectedPackage(null);
                    alert(`Paquete #${selectedPackage.paqueteNum} marcado como terminado.`);
                } catch(e) { console.error(e); alert("Error al actualizar"); }
            };

            const handlePrint = (mode = 'order') => {
                if (mode === 'ticket') {
                    document.body.classList.add('print-mode-ticket');
                    setIsTicketPrinting(true);
                } else {
                    document.body.classList.remove('print-mode-ticket');
                    setIsTicketPrinting(false);
                }
                setTimeout(() => {
                    window.print();
                    if (mode === 'ticket') {
                         document.body.classList.remove('print-mode-ticket');
                         setIsTicketPrinting(false);
                    }
                }, 500);
            };

            return (
                <div className="p-6">
                    {/* ENVOLTURA PARA IMPRESIÓN CARTA */}
                    <div className="print-visible-wrapper">
                        <div className="flex justify-between items-center mb-6">
                            <h1 className="text-4xl font-black text-slate-800 flex items-center gap-4">
                                <Icon name="file-text" size={36}/> ORDEN DE PRODUCCIÓN
                            </h1>
                            <div className="text-right">
                                <div className="text-xl font-bold text-green-700">PARTIDA: {order.partida}</div>
                                <div className="text-sm text-slate-500">CREACIÓN: {order.createdAt}</div>
                            </div>
                        </div>

                        <div className="grid grid-cols-12 gap-4 mb-6">
                            <div className="col-span-3">
                                <SmartImage repoUrls={config?.photoRepos || []} codigo={order.codigo} className="w-full h-40 object-contain bg-white rounded shadow border p-1"/>
                                <div className="text-center text-xs font-bold mt-1 text-slate-600">{order.codigo}</div>
                            </div>
                            <div className="col-span-9 grid grid-cols-4 gap-4">
                                <div className="p-3 bg-white rounded shadow col-span-2">
                                    <div className="text-xs font-bold text-slate-500">CLIENTE</div>
                                    <div className="text-xl font-black">{order.cliente}</div>
                                </div>
                                <div className="p-3 bg-white rounded shadow col-span-2">
                                    <div className="text-xs font-bold text-slate-500">MÁQUINA</div>
                                    <div className="machine-number-val text-5xl font-black text-red-600 leading-none">{order.maquina}</div>
                                </div>
                                <div className="p-3 bg-white rounded shadow">
                                    <div className="text-xs font-bold text-slate-500">PIEZAS TOTAL</div>
                                    <div className="text-3xl font-black text-indigo-700">{totalPieces.toLocaleString()}</div>
                                </div>
                                <div className="p-3 bg-white rounded shadow">
                                    <div className="text-xs font-bold text-slate-500">PESO TOTAL (Kg)</div>
                                    <div className="text-3xl font-black text-slate-800">{totalWeightKg.toFixed(2)}</div>
                                </div>
                                <div className="p-3 bg-white rounded shadow">
                                    <div className="text-xs font-bold text-slate-500">MINUTOS TOTAL</div>
                                    <div className="text-3xl font-black text-slate-800">{totalTimeMinutes.toFixed(0)}</div>
                                </div>
                                <div className="p-3 bg-white rounded shadow">
                                    <div className="text-xs font-bold text-slate-500">ESTADO</div>
                                    <div className={`text-3xl font-black ${order.status === 'TERMINADO' ? 'text-green-600' : 'text-yellow-600'}`}>{order.status}</div>
                                </div>
                            </div>
                        </div>

                        {/* DETALLE DE PIEZAS */}
                        <h3 className="font-bold text-lg mb-2 border-b pb-1 flex items-center gap-2"><Icon name="layers"/> Detalle de Piezas</h3>
                        <table className="w-full text-sm mb-6">
                            <thead>
                                <tr className="bg-slate-200">
                                    <th className="p-2 text-left">DESCRIPCIÓN</th>
                                    <th className="p-2 text-center w-24">TALLA</th>
                                    <th className="p-2 text-center w-24">TOTAL Pzs</th>
                                    <th className="p-2 text-center w-24">PESO (g)</th>
                                    <th className="p-2 text-center w-24">TIEMPO (min)</th>
                                </tr>
                            </thead>
                            <tbody>
                                {order.subPiecesData.map(p => (
                                    <tr key={p.id} className="border-b hover:bg-slate-50">
                                        <td className="p-2 font-bold">{p.pieza}</td>
                                        <td className="p-2 text-center">{p.talla}</td>
                                        <td className="p-2 text-center text-indigo-700 font-black">{Number(p.totalPedido).toLocaleString()}</td>
                                        <td className="p-2 text-center">{p.peso}</td>
                                        <td className="p-2 text-center">{p.tiempo}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                        
                        {/* TABLA DE ENHEBRADO PARA IMPRESIÓN (Versión simplificada) */}
                        <h3 className="font-bold text-lg mb-2 border-b pb-1 flex items-center gap-2 print-only"><Icon name="spool"/> Enhebrado y Consumo (Imprimir al reverso de la Ficha Técnica)</h3>
                        <div className="print-only">
                            <table className="w-full text-sm mb-6 print-only">
                                <thead>
                                    <tr className="bg-slate-200">
                                        <th className="p-2 text-left w-1/2">HILATURA</th>
                                        <th className="p-2 text-center w-1/4">PORCENTAJE (%)</th>
                                        <th className="p-2 text-center w-1/4">CONSUMO (Kg)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {order.threading.map((row, i) => {
                                        const pct = parseFloat(row.porcentaje) || 0;
                                        const requiredKg = (totalWeightKg * (pct / 100));
                                        return (
                                            <tr key={i} className="border-b">
                                                <td className="p-2 font-bold">{row.material}</td>
                                                <td className="p-2 text-center text-indigo-700 font-black">{pct.toFixed(2)} %</td>
                                                <td className="p-2 text-center">{requiredKg.toFixed(2)} Kg</td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                                <tfoot>
                                    <tr className="bg-slate-200 font-bold">
                                        <td className="p-2 text-right">TOTAL:</td>
                                        <td className="p-2 text-center text-indigo-700">{order.threading.reduce((sum, r) => sum + (parseFloat(r.porcentaje) || 0), 0).toFixed(2)} %</td>
                                        <td className="p-2 text-center">{totalWeightKg.toFixed(2)} Kg (Pedido)</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        
                        
                        {/* CONTROL DE PROGRESO */}
                        <h3 className="font-bold text-lg mb-2 border-b pb-1 flex items-center gap-2 no-print"><Icon name="bar-chart-2"/> Control de Producción</h3>
                        <div className="no-print p-4 bg-white rounded shadow mb-6">
                            <div className="flex justify-between items-center mb-3">
                                <span className="font-bold text-slate-600 text-sm">{finishedPackages} / {totalPackages} Paquetes Terminados</span>
                                <span className={`font-black text-2xl ${progressPct === 100 ? 'text-green-600' : 'text-yellow-600'}`}>{progressPct.toFixed(1)}%</span>
                            </div>
                            <div className="w-full bg-slate-200 rounded-full h-2.5">
                                <div className={`bg-green-600 h-2.5 rounded-full`} style={{width: `${progressPct}%`}}></div>
                            </div>
                        </div>
                    </div>
                    {/* FIN ENVOLTURA PARA IMPRESIÓN CARTA */}

                    {/* INTERFAZ DE REGISTRO DE PAQUETE (NO IMPRIMIR) */}
                    <div className="no-print bg-slate-100 p-4 rounded shadow-inner">
                        <div className="flex justify-between items-center mb-3">
                             <h4 className="font-bold text-md flex items-center gap-2"><Icon name="barcode"/> Registrar Paquete</h4>
                             <button onClick={() => handlePrint('ticket')} className="bg-slate-700 hover:bg-slate-600 text-white px-3 py-1 rounded text-xs font-bold flex items-center gap-1 transition-colors">
                                <Icon name="printer" size={14}/> Imprimir Etiquetas
                            </button>
                        </div>
                        {selectedPackage ? (
                            <div className="border border-indigo-300 bg-indigo-50 p-3 rounded grid grid-cols-12 gap-3 items-end">
                                <div className="col-span-12">
                                     <div className="text-xs font-bold text-indigo-700">PAQUETE SELECCIONADO</div>
                                     <div className="font-black text-lg text-indigo-900">{selectedPackage.piezaNombre} - Costura #{selectedPackage.paqueteNum} ({selectedPackage.cantidad} Pzs)</div>
                                </div>
                                <div className="col-span-3"><label className="text-[10px] font-bold">Tejedor</label><input type="text" value={entry.tejedor} onChange={toUppercase(e => setEntry({...entry, tejedor: e.target.value}))} className="w-full border p-1 rounded font-bold text-sm"/></div>
                                <div className="col-span-3"><label className="text-[10px] font-bold">Fecha</label><input type="date" value={entry.fecha} onChange={e => setEntry({...entry, fecha: e.target.value})} className="w-full border p-1 rounded text-sm"/></div>
                                <div className="col-span-3"><label className="text-[10px] font-bold">Defectos</label><input type="number" value={entry.defectos} onChange={e => setEntry({...entry, defectos: e.target.value})} className="w-full border p-1 rounded text-sm"/></div>
                                <div className="col-span-3"><label className="text-[10px] font-bold">Agujas</label><input type="text" value={entry.agujas} onChange={toUppercase(e => setEntry({...entry, agujas: e.target.value}))} className="w-full border p-1 rounded text-sm"/></div>
                                <div className="col-span-12 flex justify-end gap-2 mt-2">
                                     <button onClick={() => setSelectedPackage(null)} className="px-4 py-2 bg-slate-300 text-slate-800 font-bold rounded text-xs">Cancelar</button>
                                     <button onClick={handleFinishPackage} className="px-4 py-2 bg-green-600 text-white font-bold rounded text-xs flex items-center gap-1 transition-transform hover:scale-105" disabled={selectedPackage.finished}>
                                        <Icon name="check-circle" size={16}/> {selectedPackage.finished ? 'PAQUETE TERMINADO' : 'MARCAR COMO TERMINADO'}
                                    </button>
                                </div>
                            </div>
                        ) : (
                            <div className="text-center text-slate-400 py-4 border border-dashed border-slate-300 rounded">
                                Escanee un código de barras de paquete para registrar la producción.
                            </div>
                        )}
                    </div>

                    {/* BOTONES DE ACCIÓN (NO IMPRIMIR) */}
                    <div className="flex justify-between items-center mt-6 no-print">
                        <button onClick={onBack} className="bg-slate-500 hover:bg-slate-600 text-white px-4 py-2 rounded font-bold flex items-center gap-2"><Icon name="arrow-left" size={16}/> Volver al Listado</button>
                        <div>
                            <button onClick={() => handlePrint('order')} className="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded font-bold flex items-center gap-2 mr-2"><Icon name="printer" size={16}/> Imprimir Orden</button>
                            <button onClick={onEdit} className="bg-yellow-500 hover:bg-yellow-600 text-slate-900 px-4 py-2 rounded font-bold flex items-center gap-2"><Icon name="pencil" size={16}/> Editar Orden</button>
                        </div>
                    </div>
                    
                    {/* CONTENEDOR DE TICKETS PARA IMPRESIÓN */}
                    {isTicketPrinting && order.progreso.map((pkg, index) => (
                        <PackageTicket key={index} order={order} pkg={pkg} />
                    ))}
                </div>
            );
        };

        const MachineStatusDisplay = ({ order }) => {
            const totalPackages = order.progreso.length;
            const finishedPackages = order.progreso.filter(p => p.finished).length;
            const progressPct = totalPackages > 0 ? (finishedPackages / totalPackages) * 100 : 0;
            const isFinished = order.status === 'TERMINADO';

            const totalPieces = order.subPiecesData.reduce((sum, p) => sum + Number(p.totalPedido), 0);
            const piecesPerPackage = totalPackages > 0 ? (totalPieces / totalPackages).toFixed(0) : 0;

            return (
                <div className="flex items-center gap-3">
                    <div className="flex flex-col text-right shrink-0 w-16">
                        <span className="text-[10px] text-slate-400 leading-none">PZAS/PKG</span>
                        <span className="font-black text-sm text-yellow-500 leading-tight">{order.packageSize === 'VARIO' ? piecesPerPackage : order.packageSize}</span>
                    </div>
                    <div className="w-full flex-1">
                        <div className="text-[10px] font-bold text-slate-300 flex justify-between">
                            <span>{finishedPackages}/{totalPackages} Paquetes</span>
                            <span className={isFinished ? 'text-green-400' : 'text-yellow-400'}>{progressPct.toFixed(0)}%</span>
                        </div>
                        <div className="w-full bg-slate-500 rounded-full h-1">
                            <div className={`h-1 rounded-full ${isFinished ? 'bg-green-400' : 'bg-yellow-400'}`} style={{width: `${progressPct}%`}}></div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- COMPONENTE PRINCIPAL ---
        const App = () => {
            const [orders, setOrders] = useState([]);
            const [viewMode, setViewMode] = useState('active'); // 'active', 'history', 'finished'
            const [currentView, setCurrentView] = useState('list'); // 'list', 'new', 'view'
            const [selectedOrder, setSelectedOrder] = useState(null);
            const [clientHistory, setClientHistory] = useState([]);
            const [inventory, setInventory] = useState([]);
            const [config, setConfig] = useState({ photoRepos: [] });
            
            useEffect(() => {
                const unsubscribe = db.collection('orders').onSnapshot(snapshot => {
                    const ordersData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setOrders(ordersData);
                    const clients = [...new Set(ordersData.map(o => o.cliente).filter(Boolean))];
                    setClientHistory(clients.sort());
                }, console.error);

                const unsubscribeConfig = db.collection('config').doc('main').onSnapshot(doc => {
                    if (doc.exists) setConfig(doc.data());
                });

                const unsubscribeInventory = db.collection('inventory').doc('main').onSnapshot(doc => {
                     if(doc.exists) setInventory(doc.data().items || []);
                });

                return () => { unsubscribe(); unsubscribeConfig(); unsubscribeInventory(); };
            }, []);

            const handleNewOrder = (newOrder) => {
                setSelectedOrder(newOrder);
                setCurrentView('new');
            };

            const handleEditOrder = (order) => {
                setSelectedOrder(order);
                setCurrentView('edit');
            };

            const handleViewOrder = (order) => {
                setSelectedOrder(order);
                setCurrentView('view');
            };

            const handleCloseForm = () => {
                setSelectedOrder(null);
                setCurrentView('list');
            };

            if (currentView === 'new' || currentView === 'edit') {
                return <MultiOrderForm 
                    config={config}
                    onCancel={handleCloseForm} 
                    initialOrder={currentView === 'edit' ? selectedOrder : null} 
                    clientHistory={clientHistory} 
                    inventory={inventory}
                    isEditing={currentView === 'edit'}
                />;
            }

            if (currentView === 'view') {
                return <OrderView 
                    order={selectedOrder} 
                    config={config} 
                    onBack={handleCloseForm} 
                    onEdit={() => setCurrentView('edit')}
                />;
            }

            // LIST VIEW
            const filterAndSortOrders = useMemo(() => {
                let filtered = orders.filter(o => {
                    if (viewMode === 'active') return o.status === 'EN PROCESO';
                    if (viewMode === 'finished') return o.status === 'TERMINADO';
                    if (viewMode === 'history') return o.status === 'ARCHIVADO';
                    return false;
                }).sort((a,b) => b.id - a.id); 

                const grouped = filtered.reduce((acc, order) => {
                    const maquina = order.maquina;
                    if (!acc[maquina]) acc[maquina] = [];
                    acc[maquina].push(order);
                    return acc;
                }, {});

                return Object.keys(grouped).sort((a,b) => parseInt(a)-parseInt(b)).map(maquina => ({
                    maquina,
                    orders: grouped[maquina].sort((a, b) => {
                        const progA = a.progreso.filter(p => !p.finished).length;
                        const progB = b.progreso.filter(p => !p.finished).length;
                        return progA - progB;
                    })
                }));
            }, [orders, viewMode]);
            
            return (
                <div className="dashboard-grid">
                    <div className="top-pane">
                        <div className="max-w-7xl mx-auto p-4">
                            <div className="flex justify-between items-center mb-6 no-print">
                                <h1 className="text-3xl font-black text-slate-800 flex items-center gap-3">
                                    <Icon name="layout-dashboard" size={28}/> CIRINEO PRODUCCIÓN
                                </h1>
                                <div className="flex gap-3 items-center">
                                    <InstallButton />
                                    <button onClick={() => setCurrentView('new')} className="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded font-bold shadow flex items-center gap-2 text-sm transition-transform hover:scale-105">
                                        <Icon name="file-plus" size={16}/> Nueva Orden
                                    </button>
                                    <button onClick={() => handleNewOrder(null)} className="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded font-bold shadow flex items-center gap-2 text-sm transition-transform hover:scale-105">
                                        <Icon name="file-spreadsheet" size={16}/> Importar
                                    </button>
                                </div>
                            </div>

                            <div className="flex gap-2 mb-4 border-b pb-2 no-print">
                                <button onClick={() => setViewMode('active')} className={`px-3 py-1 text-sm font-bold rounded ${viewMode === 'active' ? 'bg-indigo-600 text-white shadow-lg' : 'bg-slate-200 text-slate-700'}`}>
                                    <Icon name="loader" size={14} className="inline mr-1"/> EN PROCESO
                                </button>
                                <button onClick={() => setViewMode('finished')} className={`px-3 py-1 text-sm font-bold rounded ${viewMode === 'finished' ? 'bg-green-600 text-white shadow-lg' : 'bg-slate-200 text-slate-700'}`}>
                                    <Icon name="check-circle" size={14} className="inline mr-1"/> TERMINADAS
                                </button>
                                <button onClick={() => setViewMode('history')} className={`px-3 py-1 text-sm font-bold rounded ${viewMode === 'history' ? 'bg-slate-600 text-white shadow-lg' : 'bg-slate-200 text-slate-700'}`}>
                                    <Icon name="archive" size={14} className="inline mr-1"/> ARCHIVO
                                </button>
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                                {filterAndSortOrders.map(group => (
                                    <div key={group.maquina} className="bg-white rounded-lg shadow-lg border-t-4 border-indigo-600 overflow-hidden">
                                        <div className="bg-indigo-50 p-3 flex justify-between items-center">
                                            <h3 className="text-xl font-black text-indigo-800">MÁQUINA #{group.maquina}</h3>
                                            <span className="text-sm font-bold text-indigo-600">{group.orders.length} órdenes</span>
                                        </div>
                                        <div className="p-3 space-y-2">
                                            {group.orders.map(order => {
                                                const totalWeightKg = order.subPiecesData.reduce((sum, p) => sum + (Number(p.totalPedido) * Number(p.peso)), 0) / 1000;
                                                return (
                                                    <div key={order.id} onClick={() => handleViewOrder(order)} className="p-2 border rounded hover:bg-slate-50 cursor-pointer transition duration-150 ease-in-out flex items-center gap-3">
                                                        <SmartImage 
                                                             repoUrls={config?.photoRepos || []} 
                                                             codigo={order.codigo} 
                                                             className="w-16 h-16 object-contain bg-white rounded border shrink-0"
                                                         />
                                                        <div className="flex-1 min-w-0">
                                                            <div className="font-bold text-sm truncate text-slate-900">{order.partida} / {order.codigo}</div>
                                                            <div className="text-xs text-slate-500 truncate">{order.cliente} - {totalWeightKg.toFixed(2)} Kg</div>
                                                            <MachineStatusDisplay order={order} />
                                                        </div>
                                                        
                                                        {/* Icono Flecha */}
                                                        <Icon name="chevron-right" size={16} className="text-slate-300 shrink-0"/>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                ))}
                                {filterAndSortOrders.length === 0 && <div className="col-span-full text-center text-slate-400 py-10 font-bold">No hay órdenes en esta vista.</div>}
                            </div>
                        </div>
                        
                        {viewMode === 'active' && <DashboardBottom activeOrders={orders.filter(o => o.status !== 'ARCHIVADO')} />}
                        {viewMode === 'history' && <div className="bg-slate-800 text-white flex items-center justify-center p-10 font-bold text-xl opacity-50">MODO HISTORIAL - SOLO LECTURA</div>}
                        
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
