<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Textil Cloud - Cirineo</title>
    
    <link id="appIcon" rel="icon" href="https://raw.githubusercontent.com/jesusvn1993mplvt3-ai/CIRINEO/refs/heads/main/maes.png">
    <meta name="theme-color" content="#1e293b">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/recharts/umd/Recharts.js"></script> <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        /* ESTILOS BASE Y DE IMPRESIÓN */
        @media print {
            @page { margin: 0.5cm; size: letter portrait; }
            body, html, #root { background: white; width: 100%; height: auto !important; overflow: visible !important; }
            .no-print, .dashboard-grid, .tv-mode { display: none !important; }
            .print-visible-wrapper { display: block !important; position: static !important; }
            /* ... (resto de estilos de impresión originales) ... */
        }
        
        .print-visible-wrapper { display: none; }
        .dashboard-grid { display: grid; grid-template-rows: 60vh 1fr; height: 100vh; overflow: hidden; }
        .tv-mode { background-color: #0f172a; color: white; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        
        /* Scrollbars para modo oscuro */
        .dark-scroll::-webkit-scrollbar { width: 8px; }
        .dark-scroll::-webkit-scrollbar-track { background: #1e293b; }
        .dark-scroll::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        .dark-scroll::-webkit-scrollbar-thumb:hover { background: #64748b; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        const { BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer } = Recharts;
        
        const firebaseConfig = {
            apiKey: "AIzaSyBqHgV4vDat1-VmZfKbiPg7nuiX-ROcexw",
            authDomain: "cirineo-cec21.firebaseapp.com",
            projectId: "cirineo-cec21",
            storageBucket: "cirineo-cec21.firebasestorage.app",
            messagingSenderId: "620210618284",
            appId: "1:620210618284:web:482bab9bf74650fff18409",
            measurementId: "G-B7YLM78RVW"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const Icon = ({ name, size = 18, className }) => <i data-lucide={name} width={size} height={size} className={className}></i>;
        const toUppercase = (handler) => (e) => { e.target.value = e.target.value.toUpperCase(); handler(e); };

        // --- FUNCIONES AUXILIARES ---
        const getMonday = (d) => {
            d = new Date(d);
            const day = d.getDay(), diff = d.getDate() - day + (day == 0 ? -6 : 1); 
            return new Date(d.setDate(diff));
        }

        // --- COMPONENTE: TARJETA DE MÁQUINA (COMPARTIDO) ---
        const MachineCard = ({ maquina, orders, isTvMode = false, onClick }) => {
            const [is24Hours, setIs24Hours] = useState(true);
            
            const pendingPackages = useMemo(() => {
                let pkgs = [];
                orders.forEach(o => {
                    const incomplete = o.progreso?.filter(p => !p.finished) || [];
                    incomplete.forEach(p => {
                        const pieceData = o.subPiecesData?.find(sp => sp.pieza === p.piezaNombre) || o;
                        const timePerPiece = Number(pieceData.tiempo) || 0;
                        pkgs.push({ ...p, parentOrderId: o.id, orderCode: o.codigo, partida: o.partida, timeTotal: (p.cantidad * timePerPiece) });
                    });
                });
                return pkgs; 
            }, [orders]);

            // Si es TV y no tiene pendientes, no renderizar nada (retornar null es manejado por el padre, pero aquí aseguramos visualmente)
            if (isTvMode && pendingPackages.length === 0) return null;

            const totalMinutesLeft = pendingPackages.reduce((sum, p) => sum + p.timeTotal, 0);
            const hoursPerDay = is24Hours ? 24 : 12;
            const daysLeft = totalMinutesLeft > 0 ? (totalMinutesLeft / 60 / hoursPerDay).toFixed(1) : 0;
            const hoursLeft = (totalMinutesLeft / 60).toFixed(1);

            return (
                <div onClick={onClick} className={`machine-card flex flex-col h-full ${isTvMode ? 'bg-slate-800 border-2 border-slate-600 hover:border-yellow-400 cursor-pointer transition-all hover:scale-[1.02]' : 'bg-slate-700 shadow-lg'} rounded-lg p-3 relative`}>
                    <div className="flex justify-between items-center border-b border-slate-500 pb-2 mb-2">
                        <div>
                            <div className="text-xs text-slate-400 font-bold uppercase">Máquina</div>
                            <div className={`${isTvMode ? 'text-5xl' : 'text-3xl'} font-black text-yellow-400`}>#{maquina}</div>
                        </div>
                        <div className="text-right">
                            {!isTvMode && <button onClick={(e)=>{e.stopPropagation(); setIs24Hours(!is24Hours)}} className="bg-slate-600 px-2 py-1 rounded text-[10px] font-bold mb-1 block w-full">
                                {is24Hours ? '24H' : '12H'}
                            </button>}
                            <div className={`${isTvMode ? 'text-xl' : 'text-xs'} font-bold text-green-400`}>{hoursLeft}h Restantes</div>
                            {isTvMode && <div className="text-xs text-slate-400">{daysLeft} días (@24h)</div>}
                        </div>
                    </div>
                    <div className="pkg-list space-y-1 flex-grow overflow-y-auto dark-scroll">
                        {pendingPackages.length === 0 && <div className="text-center text-slate-500 text-xs py-4">Máquina Libre</div>}
                        {pendingPackages.map((p, i) => (
                            <div key={i} className={`${isTvMode ? 'bg-slate-900 py-3' : 'bg-slate-800'} p-2 rounded flex gap-3 items-center text-xs border border-slate-700`}>
                                <div className={`font-black text-white ${isTvMode ? 'text-2xl w-14' : 'text-lg w-10'} text-right shrink-0`}>{p.cantidad}</div>
                                <div className="flex-grow overflow-hidden">
                                    <div className={`font-bold text-slate-300 truncate ${isTvMode ? 'text-sm' : 'text-[10px]'}`}>{p.piezaNombre}</div>
                                    <div className="text-[9px] text-yellow-500 font-black truncate">{p.partida}</div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // --- COMPONENTE REPORTES DE TV (MODAL) ---
        const TvReportModal = ({ maquina, orders, onClose }) => {
            // Lógica de cálculo
            const stats = useMemo(() => {
                const now = new Date();
                const monday = getMonday(now);
                let totalPiezasSemana = 0;
                let minutesProducedSemana = 0;
                let activeOrdersCount = 0;
                
                // Filtrar órdenes que han pasado por esta máquina
                const machineOrders = orders.filter(o => o.maquina === maquina);
                
                machineOrders.forEach(o => {
                    if(o.status !== 'ARCHIVADO') activeOrdersCount++;
                    const timePerPiece = Number(o.subPiecesData?.[0]?.tiempo) || 15; // Default 15 min si no hay dato
                    
                    o.progreso.forEach(p => {
                        if (p.finished && p.fecha) {
                            const pDate = new Date(p.fecha);
                            if (pDate >= monday) {
                                totalPiezasSemana += p.cantidad;
                                minutesProducedSemana += (p.cantidad * timePerPiece);
                            }
                        }
                    });
                });

                // Eficiencia Teórica: (Minutos Producidos / Minutos Disponibles en la semana hasta ahora)
                // Asumimos 24h desde el Lunes 00:00 hasta "Ahora"
                const msSinceMonday = now - monday;
                const minutesAvailable = Math.max(1, Math.floor(msSinceMonday / 1000 / 60)); 
                // Capamos la eficiencia al 100% si los datos manuales están raros, o dejamos que muestre >100% si son muy rápidos
                let efficiency = ((minutesProducedSemana / minutesAvailable) * 100).toFixed(1);
                
                // Generar datos ficticios para la gráfica diaria si no hay suficientes fechas reales
                const dataGraph = [
                    {name: 'Lun', uv: 0}, {name: 'Mar', uv: 0}, {name: 'Mie', uv: 0}, 
                    {name: 'Jue', uv: 0}, {name: 'Vie', uv: 0}, {name: 'Sab', uv: 0}
                ];
                // Llenar gráfica real
                 machineOrders.forEach(o => {
                    o.progreso.forEach(p => {
                         if(p.finished && p.fecha) {
                             const d = new Date(p.fecha);
                             if(d >= monday) {
                                 const dayIdx = d.getDay() - 1; // 0 para lunes
                                 if(dayIdx >= 0 && dayIdx < 6) dataGraph[dayIdx].uv += p.cantidad;
                             }
                         }
                    });
                 });

                return { totalPiezasSemana, efficiency, activeOrdersCount, dataGraph };
            }, [maquina, orders]);

            return (
                <div className="fixed inset-0 bg-black/90 z-[100] flex items-center justify-center p-10 animate-fade-in" onClick={onClose}>
                    <div className="bg-slate-900 border-2 border-yellow-500 rounded-2xl w-full max-w-5xl p-8 shadow-2xl relative" onClick={e => e.stopPropagation()}>
                        <div className="absolute top-4 right-4 text-slate-500 font-mono text-xs">MODO SEGURO ACTIVO</div>
                        
                        <div className="flex justify-between items-end mb-8 border-b border-slate-700 pb-4">
                            <div>
                                <h2 className="text-6xl font-black text-white">MÁQUINA {maquina}</h2>
                                <p className="text-xl text-yellow-400 font-bold mt-2">REPORTE SEMANAL DE PRODUCCIÓN</p>
                            </div>
                            <div className="text-right">
                                <div className="text-sm text-slate-400 font-bold uppercase">EFICIENCIA CALCULADA</div>
                                <div className={`text-6xl font-black ${stats.efficiency > 80 ? 'text-green-500' : 'text-red-500'}`}>{stats.efficiency}%</div>
                            </div>
                        </div>

                        <div className="grid grid-cols-2 gap-8">
                            {/* Stats Cards */}
                            <div className="grid grid-rows-2 gap-4">
                                <div className="bg-slate-800 p-6 rounded-xl border border-slate-600 flex items-center justify-between">
                                    <div>
                                        <div className="text-slate-400 font-bold text-sm uppercase">Piezas esta Semana</div>
                                        <div className="text-5xl font-white font-mono mt-1">{stats.totalPiezasSemana}</div>
                                    </div>
                                    <Icon name="package" size={48} className="text-blue-500"/>
                                </div>
                                <div className="bg-slate-800 p-6 rounded-xl border border-slate-600 flex items-center justify-between">
                                    <div>
                                        <div className="text-slate-400 font-bold text-sm uppercase">Órdenes Activas</div>
                                        <div className="text-5xl font-white font-mono mt-1">{stats.activeOrdersCount}</div>
                                    </div>
                                    <Icon name="layers" size={48} className="text-purple-500"/>
                                </div>
                            </div>

                            {/* Chart */}
                            <div className="bg-slate-800 p-4 rounded-xl border border-slate-600 h-64">
                                <div className="text-xs font-bold text-slate-400 mb-2 text-center">PRODUCCIÓN DIARIA (PZS)</div>
                                <ResponsiveContainer width="100%" height="100%">
                                    <BarChart data={stats.dataGraph}>
                                        <XAxis dataKey="name" stroke="#94a3b8" fontSize={12} tickLine={false}/>
                                        <YAxis stroke="#94a3b8" fontSize={12} tickLine={false}/>
                                        <Tooltip cursor={{fill: '#334155'}} contentStyle={{backgroundColor: '#1e293b', borderColor: '#475569', color: '#fff'}}/>
                                        <Bar dataKey="uv" fill="#eab308" radius={[4, 4, 0, 0]} />
                                    </BarChart>
                                </ResponsiveContainer>
                            </div>
                        </div>

                        <div className="mt-8 text-center">
                            <button onClick={onClose} className="bg-slate-700 hover:bg-slate-600 text-white px-8 py-3 rounded-lg font-bold text-lg uppercase tracking-widest border border-slate-500">
                                CERRAR REPORTE
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- VISTA DE TV ---
        const TVView = ({ orders, secureToken }) => {
            const [selectedMachine, setSelectedMachine] = useState(null);

            // Obtener solo máquinas con pendientes
            const machinesWithWork = useMemo(() => {
                const groups = {};
                orders.forEach(o => {
                    // Solo considerar ordenes con paquetes pendientes
                    const hasPending = o.progreso.some(p => !p.finished);
                    if (hasPending && o.status !== 'ARCHIVADO') {
                        if(!groups[o.maquina]) groups[o.maquina] = [];
                        groups[o.maquina].push(o);
                    }
                });
                return Object.keys(groups).sort((a,b) => parseInt(a)-parseInt(b)).map(k => ({ id: k, orders: groups[k] }));
            }, [orders]);

            const handleMachineClick = (machineId) => {
                // AQUÍ ESTÁ LA SEGURIDAD
                // Solo si el token es 'admin_remote' mostramos el reporte
                if (secureToken === 'admin_remote') {
                    setSelectedMachine(machineId);
                } else {
                    console.log("Acceso denegado: Se requiere App Segura");
                }
            };

            return (
                <div className="tv-mode p-6">
                    <div className="flex justify-between items-center mb-6">
                        <div className="flex items-center gap-3">
                            <Icon name="monitor" size={32} className="text-yellow-500"/>
                            <h1 className="text-3xl font-black tracking-tighter text-white">CONTROL DE PLANTA <span className="text-slate-500 text-lg font-normal">| EN VIVO</span></h1>
                        </div>
                        <div className="text-right">
                             <div className="text-4xl font-mono font-bold text-white">{new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                             <div className="text-sm text-slate-400 font-bold uppercase">{new Date().toLocaleDateString([], {weekday: 'long', day:'numeric', month:'long'})}</div>
                        </div>
                    </div>

                    {machinesWithWork.length === 0 ? (
                        <div className="flex-grow flex items-center justify-center flex-col text-slate-600">
                            <Icon name="check-circle" size={96} className="mb-4 opacity-50"/>
                            <h2 className="text-4xl font-bold">TODO AL DÍA</h2>
                            <p className="text-xl">No hay máquinas con producción pendiente.</p>
                        </div>
                    ) : (
                        <div className="grid grid-cols-4 gap-6 flex-grow overflow-y-auto pb-4">
                            {machinesWithWork.map(g => (
                                <div key={g.id} className="h-64 lg:h-80">
                                    <MachineCard 
                                        maquina={g.id} 
                                        orders={g.orders} 
                                        isTvMode={true} 
                                        onClick={() => handleMachineClick(g.id)}
                                    />
                                </div>
                            ))}
                        </div>
                    )}

                    {selectedMachine && (
                        <TvReportModal 
                            maquina={selectedMachine} 
                            orders={orders} 
                            onClose={() => setSelectedMachine(null)} 
                        />
                    )}
                </div>
            );
        };

        // --- COMPONENTES ORIGINALES (MANTENIDOS) ---
        // (Solo incluyo MachineCard en versión DashboardBottom normal por si acaso, 
        // pero arriba ya se hizo una versión universal).
        
        const DashboardBottom = ({ activeOrders }) => {
            const machineGroups = useMemo(() => {
                const groups = {};
                activeOrders.forEach(o => { if(!groups[o.maquina]) groups[o.maquina] = []; groups[o.maquina].push(o); });
                return Object.keys(groups).sort((a,b) => parseInt(a)-parseInt(b)).map(k => ({ id: k, orders: groups[k] }));
            }, [activeOrders]);

            return (
                <div className="bottom-pane overflow-x-auto bg-slate-900 text-white flex p-2 gap-2">
                    {machineGroups.map(g => (
                        <div key={g.id} className="min-w-[300px] w-[300px] h-full">
                            <MachineCard maquina={g.id} orders={g.orders} />
                        </div>
                    ))}
                    {machineGroups.length === 0 && <div className="text-slate-500 w-full flex items-center justify-center font-bold">No hay producción activa</div>}
                </div>
            );
        };

        // ... (Aquí irían ImportModal, SmartImage, MultiOrderForm, OrderView, ThreadingEditor, etc.
        // Como el usuario ya tiene estos, solo necesitamos integrarlos en el return final)
        // Por brevedad, asumo que el resto de componentes (ImportModal, MultiOrderForm, etc.) 
        // están presentes tal cual el código anterior. PONDRE LOS PLACEHOLDERS NECESARIOS.

        const App = () => {
            const [view, setView] = useState('dashboard');
            const [orders, setOrders] = useState([]);
            const [isTvMode, setIsTvMode] = useState(false);
            const [secureToken, setSecureToken] = useState(null);

            useEffect(() => {
                // Checar URL Params para Modo TV
                const params = new URLSearchParams(window.location.search);
                if (params.get('mode') === 'tv') {
                    setIsTvMode(true);
                    setSecureToken(params.get('access')); // Obtener token de seguridad
                }

                const u1 = db.collection('orders').onSnapshot(s => setOrders(s.docs.map(d=>d.data())));
                setTimeout(()=>lucide.createIcons(), 500);
                return () => { u1(); };
            }, []);
            
            useEffect(()=>lucide.createIcons(), [view, orders, isTvMode]);

            // --- RENDERIZADO CONDICIONAL ---
            
            // 1. SI ES MODO TV, RENDERIZAMOS SOLO LA VISTA DE TV
            if (isTvMode) {
                return <TVView orders={orders} secureToken={secureToken} />;
            }

            // 2. SI NO, RENDERIZAMOS LA APP NORMAL (Resumen del código anterior)
            // NOTA: Para que esto funcione completamente, debes pegar el resto de componentes
            // (OrderView, MultiOrderForm, etc.) dentro del script, igual que antes.
            
            // Simulación básica del Dashboard Normal para este ejemplo:
            return (
                <div className="h-screen bg-slate-100 overflow-hidden flex flex-col items-center justify-center text-slate-500">
                    <p>Esta es la vista de PC/Tablet.</p>
                    <p>Para ver la vista de TV, agrega <code>?mode=tv</code> a la URL.</p>
                    <p>Para la vista segura de TV, usa <code>?mode=tv&access=admin_remote</code></p>
                    <br/>
                    {/* Aquí iría <DashboardGrid /> con el código original */}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
