<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <title>MAES26 Dashboard</title>

    <link rel="icon" href="https://raw.githubusercontent.com/sweaters-liliana/MAES26/main/icon%20maes.svg">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/sweaters-liliana/MAES26/main/icon%20maes.svg">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">
    
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @media print {
            .no-print { display: none !important; }
            body { background: white !important; color: black !important; }
            .report-page { margin: 0; padding: 10mm; color: black !important; background: white !important; min-height: 297mm; }
        }
        .custom-scrollbar::-webkit-scrollbar { height: 6px; width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #0f172a; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        .blink-red { animation: blink-animation 1s steps(5, start) infinite; }
        @keyframes blink-animation { to { visibility: hidden; } }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Aspect Ratio 4:6 enforcement for cells */
        .cell-ratio { aspect-ratio: 4/6; }
    </style>
</head>
<body class="bg-slate-900 text-slate-200 font-sans fixed inset-0 overflow-hidden">

    <div id="root" class="h-full"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, doc, setDoc, addDoc, deleteDoc, onSnapshot, serverTimestamp, query, orderBy, limit, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const { useState, useEffect, useMemo, useRef } = React;

        const firebaseConfig = {
            apiKey: "AIzaSyBqHgV4vDat1-VmZfKbiPg7nuiX-ROcexw",
            authDomain: "cirineo-cec21.firebaseapp.com",
            projectId: "cirineo-cec21",
            storageBucket: "cirineo-cec21.firebasestorage.app",
            messagingSenderId: "620210618284",
            appId: "1:620210618284:web:482bab9bf74650fff18409",
            measurementId: "G-B7YLM78RVW"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const ROLES = { 
            ADMIN: 'admin', 
            COMMENTATOR: 'commentator', 
            OBSERVER: 'observer', 
            DEVELOPMENT: 'development',
            OPERATOR: 'operator',
            PRE_COUNT: 'pre_count'
        };
        
        const DEFAULT_USERS = {
            '1111': { name: 'Marco Espinoza', role: ROLES.ADMIN, area: 'Administración' },
            '0000': { name: 'Prisciliano Espinoza', role: ROLES.COMMENTATOR, area: 'Comentarios' },
            '2222': { name: 'Susana', role: ROLES.OBSERVER, area: 'Observación', canJustify: true }, 
            '1352': { name: 'Vallejo', role: ROLES.DEVELOPMENT, area: 'Desarrollo', canJustify: true, canManageUsers: true }, 
            '5555': { name: 'IPAD PRE', role: ROLES.PRE_COUNT, area: 'Conteo Físico' }
        };

        const MACHINES = [
            { id: 'm35', name: 'MAQ 35', type: 'SANTONI SM8' }, { id: 'm39', name: 'MAQ 39', type: 'SANTONI SM8' },
            { id: 'm40', name: 'MAQ 40', type: 'SANTONI SM8' }, { id: 'm36', name: 'MAQ 36', type: 'CIXING GE82' },
            { id: 'm38', name: 'MAQ 38', type: 'SANTONI SM8' }, { id: 'm37', name: 'MAQ 37', type: 'SANTONI SM8' },
            { id: 'm29', name: 'MAQ 29', type: 'SANTONI EVO4' }, { id: 'm28', name: 'MAQ 28', type: 'SANTONI EVO4' },
            { id: 'm27', name: 'MAQ 27', type: 'SANTONI EVO4' }, { id: 'm33', name: 'MAQ 33', type: 'SANTONI EVO4' },
            { id: 'm1',  name: 'MAQ 1',  type: 'CIXING' }, { id: 'm30', name: 'MAQ 30', type: 'CIXING GE82' },
            { id: 'm31', name: 'MAQ 31', type: 'CIXING GE82' }, { id: 'm6',  name: 'MAQ 6',  type: 'CIXING GE82' },
            { id: 'm32', name: 'MAQ 32', type: 'CIXING GE82' }, { id: 'm13', name: 'MAQ 13', type: 'SANTONI EVO4' },
            { id: 'm12', name: 'MAQ 12', type: 'SANTONI EVO4' }, { id: 'm24', name: 'MAQ 24', type: 'SANTONI EVO4' },
            { id: 'm8',  name: 'MAQ 8',  type: 'SANTONI TOP2' },
        ];

        // --- UTILS ---
        const getWeekNumber = (d) => {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
            const weekNo = Math.ceil(( ( (d - yearStart) / 86400000) + 1)/7);
            return `${d.getUTCFullYear()}-W${weekNo}`;
        };

        const generateCalendar = () => {
            const dates = [];
            const months = ['ENE', 'FEB', 'MAR', 'ABR', 'MAY', 'JUN', 'JUL', 'AGO', 'SEP', 'OCT', 'NOV', 'DIC'];
            const start = new Date(2025, 8, 1); 
            const end = new Date(2026, 11, 31);
            let idx = 0;
            for (let d = start; d <= end; d.setDate(d.getDate() + 1)) {
                dates.push({
                    index: idx++,
                    id: `${['DOM','LUN','MAR','MIE','JUE','VIE','SAB'][d.getDay()]} ${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear()}`,
                    shortDay: ['DOM', 'LUN', 'MAR', 'MIE', 'JUE', 'VIE', 'SAB'][d.getDay()],
                    dateNum: d.getDate(),
                    month: months[d.getMonth()],
                    monthIndex: d.getMonth(),
                    year: d.getFullYear(), 
                    isoDate: d.toISOString().split('T')[0],
                    weekId: getWeekNumber(new Date(d))
                });
            }
            return dates;
        };

        const ALL_ROWS = generateCalendar();

        // --- COMPONENTES ---

        // Modal para Detalle de Celda y Justificaciones
        const CellDetailModal = ({ onClose, machine, dateRow, dailyEntries, metrics, justifications, onSaveJustification, user, order }) => {
            const [minutes, setMinutes] = useState('');
            const [reason, setReason] = useState('');
            const [explanation, setExplanation] = useState(justifications?.explanation || '');

            const handleAddDowntime = () => {
                if (!minutes || !reason) return alert("Ingresa minutos y motivo");
                const newDowntime = [...(justifications?.downtime || []), { minutes: Number(minutes), reason, user: user.name }];
                onSaveJustification(machine.id, dateRow.isoDate, { ...justifications, downtime: newDowntime });
                setMinutes(''); setReason('');
            };

            const handleSaveExplanation = () => {
                onSaveJustification(machine.id, dateRow.isoDate, { ...justifications, explanation });
                alert("Explicación guardada");
            };

            const totalJustified = (justifications?.downtime || []).reduce((acc, d) => acc + d.minutes, 0);

            return (
                <div className="fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center z-[60] p-4 fade-in" onClick={onClose}>
                    <div className="bg-slate-800 rounded-2xl shadow-2xl w-full max-w-lg border border-slate-700 overflow-hidden" onClick={e => e.stopPropagation()}>
                        <div className="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-900">
                            <div>
                                <h3 className="font-bold text-white uppercase text-lg">{machine.name} - {dateRow.shortDay} {dateRow.dateNum}</h3>
                                <p className="text-xs text-blue-400 font-bold">{order?.model || 'SIN PEDIDO'}</p>
                            </div>
                            <button onClick={onClose}><i data-lucide="x" className="text-slate-400 w-6 h-6"></i></button>
                        </div>
                        <div className="p-6 overflow-y-auto max-h-[70vh] custom-scrollbar space-y-6">
                            
                            {/* Resumen de Entradas */}
                            <div className="bg-slate-900/50 p-4 rounded-xl border border-slate-700">
                                <h4 className="text-blue-400 font-bold uppercase text-xs mb-3 flex items-center gap-2"><i data-lucide="list"></i> Entradas del Día</h4>
                                {dailyEntries.length === 0 ? <p className="text-slate-500 text-sm italic">Sin entradas registradas.</p> : (
                                    <div className="space-y-2">
                                        {dailyEntries.map((entry, idx) => (
                                            <div key={idx} className="flex justify-between text-sm border-b border-slate-800 pb-1">
                                                <span className="text-slate-300">{entry.operator}</span>
                                                <span className="text-slate-400 text-xs">{entry.partName}</span>
                                                <span className="font-bold text-white">{entry.qty} pzas</span>
                                            </div>
                                        ))}
                                        <div className="flex justify-between text-lg font-bold pt-2 text-green-400 border-t border-slate-600 mt-2">
                                            <span>TOTAL</span>
                                            <span>{metrics.dailyTotal} pzas</span>
                                        </div>
                                    </div>
                                )}
                            </div>

                            {/* Eficiencia */}
                            <div className="grid grid-cols-2 gap-4">
                                <div className="bg-slate-900/50 p-3 rounded-xl border border-slate-700 text-center">
                                    <p className="text-[10px] text-slate-500 uppercase">Eficiencia Calc.</p>
                                    <p className={`text-2xl font-black ${metrics.efficiencyColor}`}>{metrics.efficiency}%</p>
                                </div>
                                <div className="bg-slate-900/50 p-3 rounded-xl border border-slate-700 text-center">
                                    <p className="text-[10px] text-slate-500 uppercase">Tiempo Justificado</p>
                                    <p className="text-2xl font-black text-yellow-500">{totalJustified} min</p>
                                </div>
                            </div>

                            {/* Controles de Justificación (Solo ciertos roles) */}
                            {(user.role === ROLES.DEVELOPMENT || user.role === ROLES.OBSERVER) && (
                                <div className="space-y-4 pt-4 border-t border-slate-700">
                                    <div>
                                        <label className="text-xs font-bold text-yellow-500 uppercase mb-2 block">Agregar Tiempo Muerto (Justificante)</label>
                                        <div className="flex gap-2">
                                            <input type="number" placeholder="Min" value={minutes} onChange={e => setMinutes(e.target.value)} className="w-20 bg-slate-900 border border-slate-600 rounded p-2 text-white text-center" />
                                            <input type="text" placeholder="Motivo (ej. Muestras)" value={reason} onChange={e => setReason(e.target.value)} className="flex-1 bg-slate-900 border border-slate-600 rounded p-2 text-white" />
                                            <button onClick={handleAddDowntime} className="bg-yellow-600 hover:bg-yellow-500 text-white p-2 rounded"><i data-lucide="plus" className="w-5 h-5"></i></button>
                                        </div>
                                        <div className="mt-2 space-y-1">
                                            {(justifications?.downtime || []).map((d, i) => (
                                                <div key={i} className="text-xs text-slate-400 flex justify-between bg-slate-900 p-1 rounded"><span>{d.reason}</span><span>-{d.minutes} min</span></div>
                                            ))}
                                        </div>
                                    </div>

                                    <div>
                                        <label className="text-xs font-bold text-blue-500 uppercase mb-2 block">Explicación (Quitar alerta roja/naranja)</label>
                                        <div className="flex gap-2">
                                            <input type="text" placeholder="Razón del bajo rendimiento..." value={explanation} onChange={e => setExplanation(e.target.value)} className="flex-1 bg-slate-900 border border-slate-600 rounded p-2 text-white" />
                                            <button onClick={handleSaveExplanation} className="bg-blue-600 hover:bg-blue-500 text-white px-4 rounded font-bold text-xs">Guardar</button>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const EfficiencyCell = ({ machineId, row, order, justifications, dailyEntries, onCellClick, isHidden, globalHiddenDays }) => {
            if (isHidden) return null;
            
            const isHiddenDay = globalHiddenDays.includes(row.id);
            const dailyTotal = dailyEntries.reduce((sum, e) => sum + Number(e.qty), 0);
            
            // Lógica de Estado y Colores
            // Umbral de tiempo: 10 AM del día siguiente
            const cellDate = new Date(row.isoDate + 'T10:00:00'); // 10 am del dia de la celda
            const thresholdDate = new Date(cellDate);
            thresholdDate.setDate(thresholdDate.getDate() + 1); // 10 am del dia siguiente
            
            const now = new Date();
            const showStatus = now >= thresholdDate; // Solo mostrar colores definitivos después de las 10am sig.

            let statusColor = "bg-slate-800"; // Default (Gris Opaco antes de tiempo)
            let textColor = "text-slate-400";
            let borderColor = "border-slate-700";
            let statusIcon = null;
            let efficiency = 0;
            let efficiencyColor = "text-slate-500";
            let showBlink = false;

            // Capacidad y Eficiencia
            const operatorsCount = (order?.operators?.length || 1);
            const shiftMinutes = operatorsCount * 12 * 60; // 12 horas por operador
            const justifiedMinutes = (justifications?.downtime || []).reduce((acc, d) => acc + d.minutes, 0);
            const availableMinutes = Math.max(1, shiftMinutes - justifiedMinutes);
            const timePerPiece = Number(order?.timePerPieceMin || 0);
            
            // Si hay pedido activo en esta fecha
            const hasOrder = order && order.totalQty > 0 && 
                             order.startDate <= row.isoDate && 
                             (!order.finalStatus || order.archivedAt?.seconds * 1000 > new Date(row.isoDate).getTime());

            if (hasOrder && timePerPiece > 0) {
                const producedMinutes = dailyTotal * timePerPiece;
                efficiency = Math.min(100, (producedMinutes / availableMinutes) * 100).toFixed(0);
            }

            // Lógica de Colores "Post-10AM"
            if (showStatus) {
                if (hasOrder && dailyTotal === 0) {
                    // Pedido asignado pero 0 producción -> Rojo Parpadeante
                    // Si tiene explicación, deja de parpadear y se pone rojo fijo o naranja
                    if (justifications?.explanation) {
                         statusColor = "bg-red-900/40";
                         borderColor = "border-red-600";
                         textColor = "text-red-400";
                    } else {
                        statusColor = "bg-red-600 blink-red";
                        borderColor = "border-red-500";
                        textColor = "text-white";
                        showBlink = true;
                    }
                } else if (dailyTotal > 0) {
                    if (efficiency < 75) {
                        statusColor = "bg-orange-900/40";
                        borderColor = "border-orange-500";
                        textColor = "text-orange-400";
                        efficiencyColor = "text-orange-500";
                    } else {
                        statusColor = "bg-green-900/40";
                        borderColor = "border-green-500";
                        textColor = "text-green-400";
                        efficiencyColor = "text-green-500";
                    }
                } else if (!hasOrder) {
                    // Sin pedido -> Gris
                    statusColor = "bg-slate-800";
                }
            } else {
                // Antes de las 10 AM (Tiempo real)
                if (dailyTotal > 0) {
                     statusColor = "bg-blue-900/20"; // Indicador sutil de que lleva algo
                     textColor = "text-blue-300";
                     efficiencyColor = "text-blue-400";
                }
            }

            if (isHiddenDay) return <div className="min-w-[80px] h-[120px] bg-slate-900/50 border-r border-slate-800 flex items-center justify-center opacity-30"><i data-lucide="slash" className="w-6 h-6 text-slate-600"></i></div>;

            return (
                <div onClick={() => onCellClick(machineId, row, dailyEntries, { efficiency, dailyTotal, efficiencyColor }, justifications)} 
                     className={`min-w-[80px] h-[120px] border-r border-b ${borderColor} ${statusColor} relative flex flex-col cursor-pointer transition-colors hover:bg-white/5 group`}>
                    
                    {/* Barra Superior de Estado */}
                    <div className={`h-1.5 w-full ${hasOrder ? (showStatus && dailyTotal === 0 && !justifications?.explanation ? 'bg-red-500' : (efficiency >= 75 ? 'bg-green-500' : (efficiency > 0 ? 'bg-orange-500' : 'bg-slate-600'))) : 'bg-transparent'}`}></div>

                    {/* Contenido Principal */}
                    <div className="flex-1 flex flex-col items-center justify-center relative p-1">
                        {hasOrder && <span className="absolute top-1 text-[8px] font-bold text-slate-500 uppercase tracking-tighter truncate max-w-full px-1">{order.model}</span>}
                        
                        {/* Número Gigante Centrado */}
                        <span className={`text-3xl font-black ${textColor} drop-shadow-lg scale-y-110`}>
                            {dailyTotal > 0 ? dailyTotal : (hasOrder && showStatus ? '0' : '-')}
                        </span>
                        
                        {/* Indicadores Inferiores (Botones Visuales) */}
                        <div className="flex gap-1 mt-1 opacity-60 group-hover:opacity-100 transition-opacity">
                            {justifications?.downtime?.length > 0 && (
                                <div className="w-2 h-2 rounded-full bg-yellow-500" title="Justificante Activo"></div>
                            )}
                            {justifications?.explanation && (
                                <div className="w-2 h-2 rounded-full bg-blue-500" title="Explicación Activa"></div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [ordersData, setOrdersData] = useState({});
            const [justificationsData, setJustificationsData] = useState({});
            const [visibilityConfig, setVisibilityConfig] = useState({}); // { '2025-W10': [hiddenIds], ... }
            const [globalSettings, setGlobalSettings] = useState({ hiddenDays: [] });
            const [loading, setLoading] = useState(true);
            
            // Estado de Navegación
            const todayISO = new Date().toISOString().split('T')[0];
            const startIdx = ALL_ROWS.findIndex(r => r.isoDate === todayISO);
            const safeStartIdx = startIdx !== -1 ? Math.floor(startIdx / 7) : 0;
            const [weekOffset, setWeekOffset] = useState(safeStartIdx);
            
            // Modales
            const [selectedCell, setSelectedCell] = useState(null);
            const [showOrderManager, setShowOrderManager] = useState(false);
            const [showVisibilityModal, setShowVisibilityModal] = useState(false);
            const [usersData, setUsersData] = useState(DEFAULT_USERS);
            const [showLogin, setShowLogin] = useState(true);
            const [pinInput, setPinInput] = useState('');

            // Data Fetching
            useEffect(() => {
                const unsubOrders = onSnapshot(doc(db, 'settings', 'orders'), (s) => s.exists() && setOrdersData(s.data()));
                const unsubJustif = onSnapshot(collection(db, 'daily_justifications'), (snap) => {
                    const d = {}; snap.forEach(doc => d[doc.id] = doc.data());
                    setJustificationsData(d);
                });
                const unsubVis = onSnapshot(doc(db, 'settings', 'visibility'), (s) => {
                    if (s.exists()) {
                        const data = s.data();
                        setVisibilityConfig(data.weeks || {});
                        setGlobalSettings({ hiddenDays: data.hiddenDays || [] });
                    }
                });
                setLoading(false);
                return () => { unsubOrders(); unsubJustif(); unsubVis(); };
            }, []);

            // Handlers
            const handleLogin = (e) => {
                e.preventDefault();
                if(usersData[pinInput]) { setUser({...usersData[pinInput], id: pinInput}); setShowLogin(false); }
                else alert('PIN Incorrecto');
            };

            const handleSaveJustification = async (machineId, dateIso, data) => {
                const docId = `${dateIso}_${machineId}`;
                await setDoc(doc(db, 'daily_justifications', docId), data, { merge: true });
            };

            const handleSaveVisibility = async (hiddenMachinesInWeek) => {
                const currentWeekId = currentWeekRows[0].weekId;
                await setDoc(doc(db, 'settings', 'visibility'), {
                    weeks: { ...visibilityConfig, [currentWeekId]: hiddenMachinesInWeek },
                    hiddenDays: globalSettings.hiddenDays
                }, { merge: true });
            };

            // Derivados
            const currentWeekRows = useMemo(() => {
                const s = weekOffset * 7;
                return ALL_ROWS.slice(s, s + 7);
            }, [weekOffset]);
            
            const weekId = currentWeekRows[0]?.weekId;
            const hiddenMachinesForWeek = visibilityConfig[weekId] || [];
            const visibleMachines = MACHINES.filter(m => !hiddenMachinesForWeek.includes(m.id));

            if (loading) return <div className="h-screen bg-slate-900 flex items-center justify-center text-blue-500"><i data-lucide="loader-2" className="animate-spin w-10 h-10"></i></div>;

            if (showLogin) return (
                <div className="h-screen bg-slate-900 flex items-center justify-center p-4">
                    <form onSubmit={handleLogin} className="bg-slate-800 p-8 rounded-2xl border border-slate-700 w-full max-w-sm text-center">
                        <div className="w-16 h-16 bg-blue-600 rounded-2xl mx-auto mb-6 flex items-center justify-center shadow-lg shadow-blue-900/50"><i data-lucide="grid" className="text-white w-8 h-8"></i></div>
                        <h1 className="text-2xl font-bold text-white mb-6">MAES DASHBOARD</h1>
                        <input type="tel" value={pinInput} onChange={e=>setPinInput(e.target.value)} className="w-full bg-slate-900 border border-slate-600 rounded-xl p-4 text-center text-3xl text-white font-bold tracking-widest mb-4 outline-none focus:border-blue-500 transition-colors" placeholder="••••" autoFocus />
                        <button className="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl transition-all shadow-lg">ENTRAR</button>
                    </form>
                </div>
            );

            return (
                <div className="h-full flex flex-col bg-slate-900 overflow-hidden">
                    {/* Header */}
                    <header className="bg-slate-800 border-b border-slate-700 p-2 flex justify-between items-center z-20 shadow-md">
                        <div className="flex items-center gap-4">
                            <div className="bg-blue-600 p-2 rounded-lg"><i data-lucide="layout-grid" className="text-white w-5 h-5"></i></div>
                            <h1 className="font-bold text-white hidden md:block">CONTROL DE EFICIENCIA</h1>
                            
                            {/* Navegación Semanal */}
                            <div className="flex items-center gap-1 bg-slate-900 rounded-lg p-1 border border-slate-700 ml-4">
                                <button onClick={()=>setWeekOffset(w=>Math.max(0,w-1))} className="p-2 hover:bg-slate-700 rounded text-slate-400"><i data-lucide="chevron-left" className="w-5 h-5"></i></button>
                                <div className="px-4 text-center">
                                    <span className="block text-xs text-slate-500 font-bold uppercase">Semana {weekId?.split('-W')[1]}</span>
                                    <span className="block text-sm font-bold text-white">{currentWeekRows[0]?.month} {currentWeekRows[0]?.year}</span>
                                </div>
                                <button onClick={()=>setWeekOffset(w=>w+1)} className="p-2 hover:bg-slate-700 rounded text-slate-400"><i data-lucide="chevron-right" className="w-5 h-5"></i></button>
                            </div>
                        </div>

                        <div className="flex items-center gap-3">
                            <div className="text-right mr-2 hidden sm:block">
                                <p className="text-sm font-bold text-white">{user.name}</p>
                                <p className="text-[10px] text-slate-500 uppercase font-bold">{user.area}</p>
                            </div>
                            <button onClick={()=>setShowVisibilityModal(true)} className="p-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg" title="Ocultar Máquinas (Semanal)"><i data-lucide="eye-off" className="w-5 h-5"></i></button>
                            <button onClick={()=>setUser(null)||setShowLogin(true)} className="p-2 bg-red-900/30 text-red-400 hover:bg-red-900/50 rounded-lg"><i data-lucide="log-out" className="w-5 h-5"></i></button>
                        </div>
                    </header>

                    {/* Main Grid */}
                    <main className="flex-1 overflow-auto custom-scrollbar bg-slate-900 p-2 relative">
                        <div className="inline-block min-w-full bg-slate-800 rounded-xl border border-slate-700 overflow-hidden shadow-2xl">
                            <div className="flex">
                                {/* Columna Fija de Fechas */}
                                <div className="sticky left-0 z-30 bg-slate-800 shadow-[2px_0_10px_rgba(0,0,0,0.5)]">
                                    <div className="h-10 bg-slate-900 border-b border-r border-slate-700 flex items-center justify-center text-xs font-bold text-slate-500">FECHA</div>
                                    {currentWeekRows.map(row => (
                                        <div key={row.id} className="h-[120px] w-24 border-b border-r border-slate-700 flex flex-col items-center justify-center p-2">
                                            <span className="text-xs font-bold text-slate-400 uppercase">{row.shortDay}</span>
                                            <span className="text-2xl font-black text-white">{row.dateNum}</span>
                                        </div>
                                    ))}
                                </div>

                                {/* Columnas de Máquinas */}
                                <div className="flex">
                                    {visibleMachines.map(m => (
                                        <div key={m.id} className="flex flex-col w-[80px]"> {/* Ancho fijo reducido */}
                                            {/* Header Máquina */}
                                            <div className="h-10 bg-slate-900 border-b border-r border-slate-700 flex items-center justify-center px-1 sticky top-0 z-20">
                                                <span className="text-[10px] font-black text-blue-400 truncate" title={m.name}>{m.name.replace('MAQ ','M-')}</span>
                                            </div>
                                            
                                            {/* Celdas */}
                                            {currentWeekRows.map(row => {
                                                const order = ordersData[m.id];
                                                const verifiedCounts = order?.verifiedCounts || [];
                                                // Filtrar conteos para este día
                                                const dailyEntries = verifiedCounts.filter(vc => vc.date === row.isoDate);
                                                const justifKey = `${row.isoDate}_${m.id}`;
                                                const justifs = justificationsData[justifKey];

                                                return (
                                                    <EfficiencyCell 
                                                        key={`${m.id}-${row.id}`}
                                                        machineId={m.id}
                                                        row={row}
                                                        order={order}
                                                        isHidden={false}
                                                        dailyEntries={dailyEntries}
                                                        justifications={justifs}
                                                        globalHiddenDays={globalSettings.hiddenDays}
                                                        onCellClick={(mid, r, entries, metrics, j) => setSelectedCell({ machine: m, dateRow: r, entries, metrics, justifications: j, order })}
                                                    />
                                                );
                                            })}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </main>
                    
                    {/* Modal Visibilidad Semanal */}
                    {showVisibilityModal && (
                        <div className="fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4 fade-in">
                            <div className="bg-slate-800 p-6 rounded-2xl w-full max-w-2xl border border-slate-700 max-h-[90vh] flex flex-col">
                                <h3 className="text-xl font-bold text-white mb-4">Visibilidad para Semana {weekId}</h3>
                                <p className="text-sm text-slate-400 mb-4">Selecciona las máquinas que deseas <b>OCULTAR</b> esta semana. Al cambiar de semana, se restablecerán o usarán su propia configuración.</p>
                                <div className="grid grid-cols-2 sm:grid-cols-4 gap-2 overflow-y-auto flex-1 custom-scrollbar p-2">
                                    {MACHINES.map(m => {
                                        const isHidden = (visibilityConfig[weekId] || []).includes(m.id);
                                        return (
                                            <button key={m.id} onClick={() => {
                                                const current = visibilityConfig[weekId] || [];
                                                const newHidden = isHidden ? current.filter(id => id !== m.id) : [...current, m.id];
                                                handleSaveVisibility(newHidden);
                                            }} className={`p-3 rounded border text-sm font-bold transition-all ${isHidden ? 'bg-red-900/30 border-red-500 text-red-400' : 'bg-slate-700 border-slate-600 text-slate-300'}`}>
                                                {m.name} {isHidden ? '(Oculta)' : ''}
                                            </button>
                                        )
                                    })}
                                </div>
                                <button onClick={()=>setShowVisibilityModal(false)} className="mt-4 bg-blue-600 py-3 rounded text-white font-bold">Cerrar</button>
                            </div>
                        </div>
                    )}

                    {/* Modal Detalle Celda */}
                    {selectedCell && (
                        <CellDetailModal 
                            {...selectedCell} 
                            onClose={() => setSelectedCell(null)} 
                            onSaveJustification={handleSaveJustification}
                            user={user}
                        />
                    )}

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>