<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <title>MAES26 Control Total</title>

    <link rel="icon" href="https://raw.githubusercontent.com/sweaters-liliana/MAES26/d41232c1301add433daea006546e2c6eb8dd23e6/icon%20maes.svg">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/sweaters-liliana/MAES26/d41232c1301add433daea006546e2c6eb8dd23e6/icon%20maes.svg">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">
    
    <link rel="manifest" href='data:application/manifest+json,{
        "name": "MAES26 Control",
        "short_name": "MAES26",
        "start_url": ".",
        "display": "standalone",
        "background_color": "#0f172a",
        "theme_color": "#0f172a",
        "icons": [
            { "src": "https://raw.githubusercontent.com/sweaters-liliana/MAES26/d41232c1301add433daea006546e2c6eb8dd23e6/icon%20maes.svg", "sizes": "192x192", "type": "image/svg+xml" },
            { "src": "https://raw.githubusercontent.com/sweaters-liliana/MAES26/d41232c1301add433daea006546e2c6eb8dd23e6/icon%20maes.svg", "sizes": "512x512", "type": "image/svg+xml" }
        ]
    }'>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Segoe UI', Roboto, sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal-backdrop { background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(5px); }
        .tab-button.active { border-color: #3b82f6; background-color: #1e3a8a; color: #ffffff; }
        .input-qty { text-align: center; font-weight: bold; }
    </style>
</head>
<body>

    <div id="root" class="h-screen w-screen"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, doc, onSnapshot, setDoc, serverTimestamp, query, orderBy, limit, getDoc, getDocs, deleteDoc, runTransaction } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const { useState, useEffect, useMemo, useCallback } = React;

        const firebaseConfig = {
            apiKey: "AIzaSyBqHgV4vDat1-VmZfKbiPg7nuiX-ROcexw",
            authDomain: "cirineo-cec21.firebaseapp.com",
            projectId: "cirineo-cec21",
            storageBucket: "cirineo-cec21.firebasestorage.app",
            messagingSenderId: "620210618284",
            appId: "1:620210618284:web:482bab9bf74650fff18409",
            measurementId: "G-B7YLM78RVW"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Definiciones estáticas (Iguales en ambos archivos)
        const MACHINES = [
            { id: 'm35', name: 'MAQ 35', type: 'SANTONI' }, { id: 'm39', name: 'MAQ 39', type: 'SANTONI' },
            { id: 'm40', name: 'MAQ 40', type: 'SANTONI' }, { id: 'm36', name: 'MAQ 36', type: 'CIXING' },
            { id: 'm38', name: 'MAQ 38', type: 'SANTONI' }, { id: 'm37', name: 'MAQ 37', type: 'SANTONI' },
            { id: 'm29', name: 'MAQ 29', type: 'EVO4' },    { id: 'm28', name: 'MAQ 28', type: 'EVO4' },
            { id: 'm27', name: 'MAQ 27', type: 'EVO4' },    { id: 'm33', name: 'MAQ 33', type: 'EVO4' },
            { id: 'm1',  name: 'MAQ 1',  type: 'CIXING' }, { id: 'm30', name: 'MAQ 30', type: 'CIXING' },
            { id: 'm31', name: 'MAQ 31', type: 'CIXING' }, { id: 'm6',  name: 'MAQ 6',  type: 'CIXING' },
            { id: 'm32', name: 'MAQ 32', type: 'CIXING' }, { id: 'm13', name: 'MAQ 13', type: 'EVO4' },
            { id: 'm12', name: 'MAQ 12', type: 'EVO4' },    { id: 'm24', name: 'MAQ 24', type: 'EVO4' },
            { id: 'm8',  name: 'MAQ 8',  type: 'TOP2' },
        ];

        const generateCalendar = () => {
            const dates = [];
            const months = ['ENE', 'FEB', 'MAR', 'ABR', 'MAY', 'JUN', 'JUL', 'AGO', 'SEP', 'OCT', 'NOV', 'DIC'];
            const start = new Date(2025, 8, 1); 
            const end = new Date(2026, 11, 31);
            let idx = 0;
            for (let d = start; d <= end; d.setDate(d.getDate() + 1)) {
                dates.push({
                    index: idx++,
                    id: `${['DOMINGO','LUNES','MARTES','MIERCOLES','JUEVES','VIERNES','SABADO'][d.getDay()]} ${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear()}`,
                    shortDay: ['DOM', 'LUN', 'MAR', 'MIE', 'JUE', 'VIE', 'SAB'][d.getDay()],
                    dateNum: d.getDate(),
                    month: months[d.getMonth()],
                    year: d.getFullYear(), 
                    isoDate: d.toISOString().split('T')[0] 
                });
            }
            return dates;
        };
        const ALL_ROWS = generateCalendar();

        const findRowByISO = (isoDate) => ALL_ROWS.find(r => r.isoDate === isoDate);

        // --- COMPONENTES AUXILIARES (MODAL, ETC.) ---

        const Loader = () => (
            <div className="flex flex-col items-center justify-center h-full text-blue-400">
                <div className="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mb-4"></div>
                <p className="text-xl font-bold">Cargando datos...</p>
            </div>
        );

        const Modal = ({ children, title, onClose, className = '' }) => (
            <div className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop fade-in" onClick={onClose}>
                <div className={`bg-slate-800 border border-slate-700 p-6 rounded-2xl shadow-2xl relative max-w-lg w-full ${className}`} onClick={e => e.stopPropagation()}>
                    <h3 className="text-2xl font-bold text-white mb-4 border-b border-slate-700 pb-2">{title}</h3>
                    <button onClick={onClose} className="absolute top-4 right-4 text-slate-400 hover:text-white">
                        <i data-lucide="x" className="w-6 h-6"></i>
                    </button>
                    {children}
                </div>
            </div>
        );

        const UserManagementModal = ({ onClose, users, onSaveUser, onDeleteUser }) => {
            const [localUsers, setLocalUsers] = useState(users);
            const [newUser, setNewUser] = useState({ name: '', role: 'operator' });

            useEffect(() => setLocalUsers(users), [users]);

            const handleChange = (id, field, value) => {
                setLocalUsers(prev => prev.map(u => u.id === id ? { ...u, [field]: value } : u));
            };

            const handleNewUserChange = (field, value) => {
                setNewUser(prev => ({ ...prev, [field]: value }));
            };

            const handleSave = (user) => {
                if (user.name) {
                    onSaveUser(user);
                } else {
                    alert("El nombre de usuario no puede estar vacío.");
                }
            };

            return (
                <Modal title="Gestión de Usuarios" onClose={onClose} className="max-w-xl">
                    <div className="space-y-4 max-h-96 overflow-y-auto pr-2 no-scrollbar">
                        <div className="flex gap-2 p-3 bg-slate-700 rounded-lg">
                            <input
                                type="text"
                                placeholder="Nuevo Nombre"
                                value={newUser.name}
                                onChange={(e) => handleNewUserChange('name', e.target.value)}
                                className="flex-1 p-2 rounded bg-slate-600 text-white border border-slate-500"
                            />
                            <select
                                value={newUser.role}
                                onChange={(e) => handleNewUserChange('role', e.target.value)}
                                className="p-2 rounded bg-slate-600 text-white border border-slate-500"
                            >
                                <option value="operator">Operador</option>
                                <option value="admin">Administrador</option>
                            </select>
                            <button
                                onClick={() => { handleSave(newUser); setNewUser({ name: '', role: 'operator' }); }}
                                className="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded font-bold text-white"
                            >
                                <i data-lucide="plus" className="w-5 h-5"></i>
                            </button>
                        </div>
                        
                        {localUsers.filter(u => u.name).map((user) => (
                            <div key={user.id} className="flex gap-2 items-center p-3 bg-slate-700 rounded-lg">
                                <input
                                    type="text"
                                    value={user.name}
                                    onChange={(e) => handleChange(user.id, 'name', e.target.value)}
                                    className="flex-1 p-2 rounded bg-slate-600 text-white border border-slate-500"
                                />
                                <select
                                    value={user.role}
                                    onChange={(e) => handleChange(user.id, 'role', e.target.value)}
                                    className="p-2 rounded bg-slate-600 text-white border border-slate-500"
                                >
                                    <option value="operator">Operador</option>
                                    <option value="admin">Administrador</option>
                                </select>
                                <button
                                    onClick={() => handleSave(user)}
                                    className="px-4 py-2 bg-green-600 hover:bg-green-700 rounded font-bold text-white"
                                >
                                    Guardar
                                </button>
                                <button
                                    onClick={() => onDeleteUser(user.id)}
                                    className="px-3 py-2 bg-red-600 hover:bg-red-700 rounded text-white"
                                >
                                    <i data-lucide="trash-2" className="w-5 h-5"></i>
                                </button>
                            </div>
                        ))}
                    </div>
                </Modal>
            );
        };
        
        // ... Otros Modals (CalendarModal, ArchiveModal, StatsModal, InstallModal) irían aquí si los hubieras incluido ...
        
        // El resto de los Modals (CalendarModal, ArchiveModal, StatsModal, InstallModal) 
        // están omitidos aquí por brevedad, pero deberían estar presentes en tu archivo original.
        // Asumimos que están en el archivo original y no los has modificado.
        
        // --- COMPONENTE DE VISTA MÓVIL (DATA ENTRY) ---

        const MobileView = ({ todayRowId, data, ordersData, operators, handleUpdateSlot, handleSelectOrder, handleSetDisabledDates }) => {
            const [selectedMachine, setSelectedMachine] = useState(MACHINES[0].id);

            const machine = MACHINES.find(m => m.id === selectedMachine);
            const rowData = data[todayRowId]?.[selectedMachine] || {};
            const slots = rowData.slots || [{}, {}, {}, {}]; 
            const order = ordersData[selectedMachine];

            const OrderSelect = ({ machineId, currentOrder, onSelect, onDisableDate }) => (
                <div className="bg-slate-700 p-4 rounded-xl shadow-inner mb-4">
                    <h3 className="text-xl font-bold text-white mb-2 flex items-center justify-between">
                        Orden de Producción
                        <button 
                            onClick={() => onDisableDate(machineId)} 
                            className="text-xs text-red-400 bg-red-900/50 hover:bg-red-900 px-2 py-1 rounded font-bold flex items-center"
                        >
                            <i data-lucide="calendar-off" className="w-4 h-4 mr-1"></i>
                            Día Muerto
                        </button>
                    </h3>
                    
                    {currentOrder && currentOrder.model ? (
                        <div className="text-center p-3 border border-blue-500/50 bg-blue-900/20 rounded-lg">
                            <p className="text-sm text-slate-400 font-medium">Modelo Activo:</p>
                            <span className="text-3xl font-black text-yellow-400">{currentOrder.model}</span>
                            <div className="mt-2 text-xs text-slate-400">
                                {currentOrder.timePerPieceMin > 0 && <span>Tiempo por pza: **{currentOrder.timePerPieceMin} min** | </span>}
                                {currentOrder.totalQty > 0 && <span>Total a producir: **{currentOrder.totalQty} pzas**</span>}
                            </div>
                            <button 
                                onClick={() => onSelect(machineId, null)} 
                                className="mt-3 text-xs text-red-400 hover:text-red-300 font-bold"
                            >
                                Cambiar / Finalizar Orden
                            </button>
                        </div>
                    ) : (
                        <button 
                            onClick={() => onSelect(machineId, {})} 
                            className="w-full p-4 bg-blue-600 hover:bg-blue-700 rounded-lg font-bold text-white text-lg transition-colors"
                        >
                            <i data-lucide="plus" className="w-5 h-5 inline mr-2"></i>
                            Asignar Nueva Orden
                        </button>
                    )}
                </div>
            );

            const SlotInput = ({ slotIndex, label, currentQty, currentModel }) => (
                <div className="bg-slate-800 p-3 rounded-lg border border-slate-700 shadow-lg">
                    <label className="block text-xs font-bold uppercase tracking-wider text-blue-400 mb-2">{label}</label>
                    <div className="flex gap-2">
                        <input
                            type="text"
                            placeholder="Modelo"
                            value={currentModel || ''}
                            onChange={(e) => handleUpdateSlot(todayRowId, selectedMachine, slotIndex, 'model', e.target.value.toUpperCase())}
                            className="flex-1 p-2 rounded bg-slate-900 text-white border border-slate-700 text-sm"
                            disabled={!order?.model}
                        />
                        <input
                            type="number"
                            placeholder="Qty"
                            value={currentQty || ''}
                            onChange={(e) => handleUpdateSlot(todayRowId, selectedMachine, slotIndex, 'qty', e.target.value)}
                            className="w-20 p-2 rounded bg-slate-900 text-yellow-400 border border-slate-700 input-qty text-lg"
                            disabled={!order?.model}
                        />
                    </div>
                </div>
            );

            return (
                <div className="h-full flex flex-col fade-in">
                    <header className="p-4 bg-slate-900 border-b border-slate-800 shadow-xl">
                        <div className="flex overflow-x-auto no-scrollbar pb-2 space-x-2">
                            {MACHINES.map(m => (
                                <button
                                    key={m.id}
                                    onClick={() => setSelectedMachine(m.id)}
                                    className={`flex-shrink-0 px-4 py-2 rounded-full font-bold text-sm transition-all ${
                                        selectedMachine === m.id 
                                        ? 'bg-blue-600 text-white shadow-lg shadow-blue-500/30' 
                                        : 'bg-slate-700 text-slate-300 hover:bg-slate-600'
                                    }`}
                                >
                                    {m.name}
                                </button>
                            ))}
                        </div>
                    </header>
                    
                    <main className="flex-1 p-4 overflow-y-auto no-scrollbar">
                        <h2 className="text-3xl font-black text-white mb-2">{machine?.name}</h2>
                        <p className="text-sm text-slate-400 font-medium mb-4">Ingreso para hoy: **{findRowByISO(todayRowId)?.id}**</p>

                        <OrderSelect 
                            machineId={selectedMachine} 
                            currentOrder={order} 
                            onSelect={handleSelectOrder}
                            onDisableDate={handleSetDisabledDates}
                        />

                        {order?.model && (
                            <div className="space-y-4">
                                <SlotInput slotIndex={0} label="Turno Mañana (Slot 1)" currentQty={slots[0]?.qty} currentModel={slots[0]?.model} />
                                <SlotInput slotIndex={1} label="Turno Noche (Slot 2)" currentQty={slots[1]?.qty} currentModel={slots[1]?.model} />
                                <SlotInput slotIndex={2} label="Turno Extra 1 (Slot 3)" currentQty={slots[2]?.qty} currentModel={slots[2]?.model} />
                                <SlotInput slotIndex={3} label="Turno Extra 2 (Slot 4)" currentQty={slots[3]?.qty} currentModel={slots[3]?.model} />
                                
                                <div className="p-4 bg-emerald-900/20 rounded-lg text-center font-black mt-6 border border-emerald-700">
                                    <span className="text-lg text-slate-300 block">TOTAL REGISTRADO HOY</span>
                                    <span className="text-5xl text-emerald-400">{rowData.actual || 0}</span>
                                </div>
                            </div>
                        )}
                        
                    </main>
                </div>
            );
        };

        // --- COMPONENTE PRINCIPAL ---

        const App = () => {
            const [data, setData] = useState({}); // produccion_2026 (Detailed data)
            const [ordersData, setOrdersData] = useState({}); // settings/orders
            const [usersData, setUsersData] = useState([]);
            const [userData, setUserData] = useState(null);
            const [loading, setLoading] = useState(true);
            const [viewPreference, setViewPreference] = useState(localStorage.getItem('viewPreference') || 'mobile');
            
            // UI State
            const [showUserManagementModal, setShowUserManagementModal] = useState(false);
            const [showOrderModal, setShowOrderModal] = useState(false);
            const [currentMachineForOrder, setCurrentMachineForOrder] = useState(null);
            const [orderToEdit, setOrderToEdit] = useState(null);

            const today = new Date();
            const todayISO = today.toISOString().split('T')[0];
            const todayRow = findRowByISO(todayISO);
            const todayRowId = todayRow?.id;
            
            const isAdmin = userData?.role === 'admin';
            const canManageUsers = userData?.role === 'admin';
            const machineTotals = useMemo(() => calculateTotals(data, MACHINES, ALL_ROWS), [data]);
            const dailyTotals = useMemo(() => calculateDailyTotals(data, MACHINES, ALL_ROWS), [data]);


            // --- HANDLERS (BASE DE DATOS) ---

            useEffect(() => {
                const unsubAuth = onAuthStateChanged(auth, (u) => {
                    if (u) {
                        const userRef = doc(db, 'users', u.uid);
                        onSnapshot(userRef, (docSnap) => {
                            if (docSnap.exists()) {
                                setUserData({ uid: u.uid, ...docSnap.data() });
                            } else {
                                // Default role for new users
                                setDoc(userRef, { name: 'Operador Desconocido', role: 'operator' }, { merge: true });
                                setUserData({ uid: u.uid, name: 'Operador Desconocido', role: 'operator' });
                            }
                            setLoading(false);
                        });
                        
                        // Listeners for data
                        onSnapshot(collection(db, 'produccion_2026'), (snap) => { 
                            const d = {}; 
                            snap.forEach(doc => d[doc.id] = doc.data()); 
                            setData(d); 
                        });
                        onSnapshot(doc(db, 'settings', 'orders'), (docSnap) => { 
                            if (docSnap.exists()) setOrdersData(docSnap.data()); 
                        });
                        onSnapshot(collection(db, 'users'), (snap) => {
                            const u = [];
                            snap.forEach(doc => u.push({ id: doc.id, ...doc.data() }));
                            setUsersData(u);
                        });
                        
                    } else {
                        signInAnonymously(auth).catch(err => console.error("Error login:", err));
                    }
                });
                return () => unsubAuth();
            }, []);
            
            useEffect(() => {
                // Initialize Lucide icons after state change
                if (window.lucide) window.lucide.createIcons();
            }, [userData, viewPreference, showUserManagementModal, showOrderModal]);


            // --- LÓGICA CORE DE INGRESO DE DATOS (CORREGIDA) ---
            const handleUpdateSlot = async (rowId, machineId, slotIndex, field, value) => {
                if (!todayRowId || rowId !== todayRowId) {
                    alert("Solo se puede editar la producción del día de hoy.");
                    return;
                }
                
                // 1. Calcular la nueva estructura de slots localmente
                const currentMachineData = data[rowId]?.[machineId] || {};
                const currentSlots = currentMachineData.slots || [{}, {}, {}, {}];
                const updatedSlots = [...currentSlots];
                
                if (!updatedSlots[slotIndex]) updatedSlots[slotIndex] = {};
                
                if (field === 'qty') {
                    updatedSlots[slotIndex].qty = value === '' ? '' : Math.max(0, Number(value));
                } else {
                    updatedSlots[slotIndex].model = value;
                }

                // 2. Calcular el total real (suma de turnos)
                const newTotalActual = updatedSlots.reduce((acc, s) => acc + (Number(s?.qty) || 0), 0);
                
                // --- CORRECCIÓN IMPORTANTE PARA EL MONITOR (REPORTE DETALLADO) ---
                // Generar desglose de turnos/operadores para el Monitor, ya que se solicitó el reporte detallado
                // Asumimos que los 4 slots de MobileView corresponden a 4 posibles turnos/reportes.
                const OPERATOR_NAMES = ['Turno Mañana', 'Turno Noche', 'Turno Extra 1', 'Turno Extra 2']; 
                const operatorsList = [];
                
                updatedSlots.forEach((slot, idx) => {
                    const q = Number(slot.qty) || 0;
                    if (q > 0) {
                        operatorsList.push({
                            name: OPERATOR_NAMES[idx] || `Slot ${idx + 1}`,
                            count: q
                        });
                    }
                });
                // -----------------------------------------------------------------

                // 3. Preparar el objeto completo para la base de datos de administración (produccion_2026)
                const updatedMachine = { ...currentMachineData, slots: updatedSlots, actual: newTotalActual };

                // 4. Preparar el objeto para el MONITOR (monitor_data_2026)
                const monitorPayload = {
                    [machineId]: {
                        dailyCount: newTotalActual,
                        operators: operatorsList, // <--- DETALLE PARA EL REPORTE DEL MONITOR
                        lastUpdated: serverTimestamp()
                    }
                };

                // 5. ENVIAR A AMBAS BASES DE DATOS USANDO BATCH
                try {
                    const batchPromises = [
                        // A. Guardar en la base de datos de administración (Detallada)
                        setDoc(doc(db, 'produccion_2026', rowId), { [machineId]: updatedMachine }, { merge: true }),
                        
                        // B. Guardar en la base de datos del MONITOR (Simplificada pero con desglose)
                        setDoc(doc(db, 'monitor_data_2026', rowId), monitorPayload, { merge: true })
                    ];

                    await Promise.all(batchPromises);
                } catch (error) {
                    console.error("Error actualizando datos:", error);
                    alert("Error de conexión al guardar.");
                }
            };

            const handleSelectOrder = (machineId, orderDetails) => {
                setCurrentMachineForOrder(machineId);
                setOrderToEdit(orderDetails); // Si es null, abre el modal para crear/seleccionar
                setShowOrderModal(true);
            };

            const handleSaveOrder = async (machineId, orderDetails) => {
                try {
                    const payload = {
                        [machineId]: {
                            ...orderDetails,
                            lastUpdated: serverTimestamp()
                        }
                    };
                    await setDoc(doc(db, 'settings', 'orders'), payload, { merge: true });
                    setShowOrderModal(false);
                } catch (error) {
                    console.error("Error guardando orden:", error);
                    alert("Error guardando orden de producción.");
                }
            };

            const handleSetDisabledDates = async (machineId) => {
                if (!todayRow) return alert("No se pudo identificar la fecha de hoy.");
                
                const confirmed = window.confirm(`¿Confirmas marcar el día de hoy (${todayRow.isoDate}) como **Día Muerto** para la máquina ${MACHINES.find(m => m.id === machineId)?.name}? Esto evitará que parpadee en el Monitor.`);

                if (confirmed) {
                    try {
                        await runTransaction(db, async (transaction) => {
                            const ordersRef = doc(db, 'settings', 'orders');
                            const docSnap = await transaction.get(ordersRef);
                            
                            const currentOrders = docSnap.data() || {};
                            const machineOrder = currentOrders[machineId] || {};
                            const disabledDates = new Set(machineOrder.disabledDates || []);
                            
                            disabledDates.add(todayRow.isoDate);
                            
                            transaction.set(ordersRef, { 
                                [machineId]: { 
                                    ...machineOrder, 
                                    disabledDates: Array.from(disabledDates),
                                    lastUpdated: serverTimestamp()
                                } 
                            }, { merge: true });
                        });
                        alert(`Día ${todayRow.isoDate} marcado como "Día Muerto" para ${MACHINES.find(m => m.id === machineId)?.name}.`);
                    } catch (error) {
                        console.error("Error marcando día muerto:", error);
                        alert("Error al guardar la configuración.");
                    }
                }
            };
            
            const handleSaveUser = async (user) => {
                const userRef = doc(db, 'users', user.id || newId(db));
                await setDoc(userRef, { name: user.name, role: user.role, lastUpdated: serverTimestamp() }, { merge: true });
            };

            const handleDeleteUser = async (userId) => {
                if (window.confirm("¿Estás seguro de eliminar este usuario?")) {
                    await deleteDoc(doc(db, 'users', userId));
                }
            };

            if (loading) return <Loader />;

            return (
                <div className="h-screen bg-slate-900">
                    <header className="p-3 bg-slate-950 border-b border-slate-800 shadow-xl flex justify-between items-center z-10">
                        <div className="flex items-center">
                            <img src="https://raw.githubusercontent.com/sweaters-liliana/MAES26/d41232c1301add433daea006546e2c6eb8dd23e6/icon%20maes.svg" className="w-10 h-10 rounded mr-3" />
                            <h1 className="text-xl font-black text-white">MAES26 Control</h1>
                        </div>
                        <div className="flex items-center space-x-3">
                            {/* Opciones de Administrador */}
                            {isAdmin && (
                                <>
                                    <button onClick={() => setShowOrderModal(true)} className="p-2 text-yellow-400 hover:text-yellow-300">
                                        <i data-lucide="settings-2" className="w-5 h-5"></i>
                                    </button>
                                    <button onClick={() => setShowUserManagementModal(true)} className="p-2 text-green-400 hover:text-green-300">
                                        <i data-lucide="users" className="w-5 h-5"></i>
                                    </button>
                                </>
                            )}
                            <button onClick={() => signOut(auth)} className="p-2 text-red-400 hover:text-red-300">
                                <i data-lucide="log-out" className="w-5 h-5"></i>
                            </button>
                        </div>
                    </header>
                    
                    <MobileView 
                        todayRowId={todayRowId} 
                        data={data} 
                        ordersData={ordersData} 
                        handleUpdateSlot={handleUpdateSlot}
                        handleSelectOrder={handleSelectOrder}
                        handleSetDisabledDates={handleSetDisabledDates}
                    />

                    {/* MODALS */}
                    {showUserManagementModal && <UserManagementModal onClose={() => setShowUserManagementModal(false)} users={usersData} onSaveUser={handleSaveUser} onDeleteUser={handleDeleteUser} />}
                    {/* ... Otros Modals (OrderModal, CalendarModal, etc.) ... */}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>